<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Healthie AI</title>
  <style>
    body { font-family: sans-serif; padding: 1em; background: #f4f4f4; }
    #quiz-container, #chat-container {
      max-width: 500px; margin: auto; background: white; padding: 1em; border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    #messages {
      max-height: 400px; overflow-y: auto; margin-bottom: 1em;
      display: flex; flex-direction: column;
    }
    .msg { padding: 0.5em; margin: 0.5em 0; border-radius: 10px; }
    .user { background: #d0f0ff; align-self: flex-end; }
    .ai { background: #f0f0f0; align-self: flex-start; }
    #loader { text-align: center; padding: 1em; font-style: italic; }
  </style>
</head>
<body>

<div id="quiz-container" style="display:none;"></div>
<div id="chat-container" style="display:none;">
  <h2>Healthie AI</h2>
  <div id="messages"></div>
  <form id="chat-form">
    <input type="text" id="user-input" placeholder="–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off" required />
    <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </form>
</div>
<div id="loader" style="display:none;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

<script>
  const SHEETS_API_URL = 'https://cold-credit-3c5d.arsivals.workers.dev/sheet';
  const GEMINI_API_URL = 'https://cold-credit-3c5d.arsivals.workers.dev/gemini';

  const getUserId = () => {
    try {
      if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe?.user?.id) {
        return Telegram.WebApp.initDataUnsafe.user.id.toString();
      }
    } catch {}
    return 'test_user';
  };

  const quizSteps = [
    { key: 'name', text: '–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?', type: 'text' },
    { key: 'running_frequency', text: '–°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é —Ö–æ—á–µ—à—å –±–µ–≥–∞—Ç—å?', type: 'select', options: ['1', '2', '3', '4+'] },
    { key: 'coaching_style', text: '–í—ã–±–µ—Ä–∏ —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è:', type: 'select', options: ['–ñ–µ–ª–µ–∑–Ω—ã–π –ù–∞—Å—Ç–∞–≤–Ω–∏–∫', '–≠–Ω–µ—Ä–¥–∂–∞–π–∑–µ—Ä-–ó–∞–∂–∏–≥–∞–ª–∫–∞', '–°–ø–æ–∫–æ–π–Ω—ã–π –ú—É–¥—Ä–µ—Ü', '–ê–ë–°–û–õ–Æ–¢–ù–´–ô –î–û–ú–ò–ù–ê–¢–û–†'] },
    { key: 'dominant_style_consent', text: '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—à—å "–î–û–ú–ò–ù–ê–¢–û–†–ê"?', type: 'select', options: ['–Ω–µ—Ç', '–¥–∞'] }
  ];

  let quizData = {};

  async function fetchUserData() {
    const user_id = getUserId();
    try {
      const res = await fetch(`${SHEETS_API_URL}?user_id=${user_id}`);
      const json = await res.json();
      return json?.data || null;
    } catch (e) {
      return null;
    }
  }

  async function saveQuizData(data) {
    const user_id = getUserId();
    const body = { user_id, ...data };
    const res = await fetch(SHEETS_API_URL, {
      method: 'POST',
      body: JSON.stringify(body),
      headers: { 'Content-Type': 'application/json' }
    });
    return await res.json();
  }

  async function sendMessageToAI(userMessage) {
    const profileText = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${quizData.name}, —Ö–æ—á–µ—Ç –±–µ–≥–∞—Ç—å ${quizData.running_frequency} —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é, —Å—Ç–∏–ª—å: ${quizData.coaching_style}.`;
    const conversation = (quizData.last_messages || []).concat([{ role: 'user', text: userMessage }]);
    let prompt = `–¢—ã ‚Äî AI-—Ç—Ä–µ–Ω–µ—Ä –ø–æ –±–µ–≥—É. ${profileText}\n\n–ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞:\n`;
    conversation.forEach(msg => {
      prompt += (msg.role === 'user' ? '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ' : 'AI: ') + msg.text + '\n';
    });
    prompt += '–û—Ç–≤–µ—Ç—å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –∏ –º–æ—Ç–∏–≤–∏—Ä—É—é—â–µ.';

    const res = await fetch(GEMINI_API_URL, {
      method: 'POST',
      body: JSON.stringify({ prompt }),
      headers: { 'Content-Type': 'application/json' }
    });
    const json = await res.json();
    return json?.response || '–û—Ç–≤–µ—Ç –æ—Ç AI –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
  }

  function showStep(i) {
    const quizContainer = document.getElementById('quiz-container');
    const st = quizSteps[i];
    quizContainer.innerHTML = `<h3>${st.text}</h3>`;
    const inputHtml = st.type === 'text'
      ? `<input id="input" required />`
      : `<select id="input">${st.options.map(o => `<option value="${o}">${o}</option>`).join('')}</select>`;
    quizContainer.innerHTML += inputHtml + `<button id="next">–î–∞–ª–µ–µ</button>`;
    document.getElementById('next').onclick = () => {
      const val = document.getElementById('input').value.trim();
      if (!val) return;
      quizData[st.key] = (st.type === 'select' && st.key === 'dominant_style_consent' && quizData.coaching_style !== '–ê–ë–°–û–õ–Æ–¢–ù–´–ô –î–û–ú–ò–ù–ê–¢–û–†') ? '–Ω–µ—Ç' : val;
      if (i + 1 < quizSteps.length) showStep(i + 1);
      else finishQuiz();
    };
  }

  async function finishQuiz() {
    document.getElementById('quiz-container').style.display = 'none';
    document.getElementById('loader').style.display = 'block';
    await saveQuizData(quizData);
    await startChat(true);
    document.getElementById('loader').style.display = 'none';
  }

  async function loadChatHistory() {
    const userData = await fetchUserData();
    if (!userData) return [];
    if (userData.last_messages && Array.isArray(userData.last_messages)) {
      quizData = userData; // –≤–∞–∂–Ω–æ: –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º –≤—Å—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É, —á—Ç–æ–±—ã last_greet_ts –±—ã–ª
      return userData.last_messages;
    }
    return [];
  }

  async function updateLastMessages(messages) {
    const dataToSave = {
      ...quizData,
      last_messages: messages
    };
    await saveQuizData(dataToSave);
    quizData.last_messages = messages;
  }

  async function generateGreetingFromAI() {
    const history = quizData.last_messages || [];
    const profileText = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${quizData.name}, —Ö–æ—á–µ—Ç –±–µ–≥–∞—Ç—å ${quizData.running_frequency} —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é, —Å—Ç–∏–ª—å: ${quizData.coaching_style}.`;
    let prompt = `–¢—ã ‚Äî AI-—Ç—Ä–µ–Ω–µ—Ä –ø–æ –±–µ–≥—É. ${profileText}\n\n–ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞:\n`;
    history.forEach(msg => {
      prompt += (msg.role === 'user' ? '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ' : 'AI: ') + msg.text + '\n';
    });
    prompt += `\n–ü—Ä–æ–¥–æ–ª–∂–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä, –ø—Ä–æ—è–≤–∏ –∑–∞–±–æ—Ç—É –∏ –ø–æ–¥–¥–µ—Ä–∂–∫—É. –°–ø—Ä–æ—Å–∏, –∫–∞–∫ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–µ–ª–∞, –µ—Å—Ç—å –ª–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å –∏–ª–∏ –≤–æ–ø—Ä–æ—Å—ã. –û—Ç–≤–µ—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º.`;

    const res = await fetch(GEMINI_API_URL, {
      method: 'POST',
      body: JSON.stringify({ prompt }),
      headers: { 'Content-Type': 'application/json' }
    });
    const json = await res.json();
    return json?.response || '–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ —Ç–≤–æ–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏?';
  }

  async function startChat(withGreeting = false) {
    const chatContainer = document.getElementById('chat-container');
    const messagesDiv = document.getElementById('messages');
    const form = document.getElementById('chat-form');
    const input = document.getElementById('user-input');

    chatContainer.style.display = 'block';
    messagesDiv.innerHTML = '';

    const history = await loadChatHistory();
    quizData.last_messages = history;
    const lastMsg = history[history.length - 1];

    for (const msg of history) {
      const cls = msg.role === 'user' ? 'user' : 'ai';
      messagesDiv.innerHTML += `<div class="msg ${cls}">${msg.role === 'user' ? 'üë§' : 'ü§ñ'} ${msg.text}</div>`;
    }
    messagesDiv.scrollTop = messagesDiv.scrollHeight;

    if (withGreeting) {
      const lastGreeted = quizData.last_greet_ts ? new Date(quizData.last_greet_ts).getTime() : 0;
      const now = Date.now();

      const shouldGreet =
        (!quizData.last_greet_ts || now - lastGreeted > 6 * 60 * 60 * 1000) &&
        lastMsg?.role === 'user';

      console.log('last_greet_ts:', quizData.last_greet_ts);
      console.log('now:', new Date(now).toISOString());
      console.log('lastMsg:', lastMsg);
      console.log('shouldGreet:', shouldGreet);

      if (history.length === 0) {
        const profileText = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${quizData.name}, —Ö–æ—á–µ—Ç –±–µ–≥–∞—Ç—å ${quizData.running_frequency} —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é, —Å—Ç–∏–ª—å: ${quizData.coaching_style}.`;
        const prompt = `–¢—ã ‚Äî AI-—Ç—Ä–µ–Ω–µ—Ä –ø–æ –±–µ–≥—É. ${profileText}\n\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–æ–ª—å–∫–æ —á—Ç–æ –∑–∞–≤–µ—Ä—à–∏–ª –∫–≤–∏–∑. –ù–∞—á–Ω–∏ –ø–µ—Ä–≤—ã–π –¥–∏–∞–ª–æ–≥ –Ω–∞ —Ç–µ–º—É –±–µ–≥–∞.`;
        const reply = await sendMessageToAI(prompt);
        messagesDiv.innerHTML += `<div class="msg ai">ü§ñ ${reply}</div>`;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        await updateLastMessages([{ role: 'ai', text: reply }]);
        quizData.last_greet_ts = new Date().toISOString();
        await saveQuizData(quizData);
      } else if (shouldGreet) {
        console.log('–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        const greetMsg = await generateGreetingFromAI();
        messagesDiv.innerHTML += `<div class="msg ai">ü§ñ ${greetMsg}</div>`;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        const updatedMessages = [...quizData.last_messages, { role: 'ai', text: greetMsg }].slice(-15);
        await saveQuizData({
          ...quizData,
          last_messages: updatedMessages,
          last_greet_ts: new Date().toISOString()
        });

        quizData.last_messages = updatedMessages;
        quizData.last_greet_ts = new Date().toISOString();
      }
    }

    form.onsubmit = async (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text) return;

      messagesDiv.innerHTML += `<div class="msg user">üë§ ${text}</div>`;
      input.value = '';
      messagesDiv.scrollTop = messagesDiv.scrollHeight;

      const reply = await sendMessageToAI(text);
      messagesDiv.innerHTML += `<div class="msg ai">ü§ñ ${reply}</div>`;
      messagesDiv.scrollTop = messagesDiv.scrollHeight;

      const updatedMessages = [
        ...(quizData.last_messages || []),
        { role: 'user', text },
        { role: 'ai', text: reply }
      ].slice(-15);

      await updateLastMessages(updatedMessages);
    };
  }

  document.addEventListener('DOMContentLoaded', async () => {
    const existingData = await fetchUserData();
    if (existingData && Object.keys(existingData).length >= quizSteps.length) {
      quizData = existingData;
      await startChat(true);
    } else {
      document.getElementById('quiz-container').style.display = 'block';
      showStep(0);
    }
  });
</script>
</body>
</html>