<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Duco AI</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
      overflow: hidden;
      -webkit-overflow-scrolling: touch;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-image: var(--bg-url, url('bg/default.jpg'));
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      z-index: -1;
    }

    #loader {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      font-size: 1.2em;
      color: #fff;
      backdrop-filter: blur(6px);
    }

    #quiz-container, #chat-container {
      max-width: 500px;
      margin: auto;
      height: 100vh;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
      padding: 1em;
      background: transparent;
    }

    #quiz-container {
      justify-content: center;
      align-items: center;
      text-align: center;
      transition: all 0.3s ease-in-out;
    }

    #quiz-container h3 {
      font-size: 1.2em;
      color: #fff;
      margin-bottom: 1em;
      max-width: 90%;
    }

    #quiz-container input,
    #quiz-container select,
    #quiz-container textarea {
      width: 100%;
      padding: 14px;
      font-size: 1.1em;
      border-radius: 20px;
      border: none;
      margin-bottom: 1em;
      background: rgba(255, 255, 255, 0.9);
      color: #000;
      transition: all 0.3s ease;
    }

    #quiz-container textarea {
      min-height: 50px;
      max-height: 100px;
      resize: vertical;
      box-sizing: border-box;
    }

    #quiz-container button {
      padding: 14px 20px;
      font-size: 1.1em;
      border: none;
      border-radius: 25px;
      background-color: #5865F2;
      color: white;
      width: 100%;
      transition: all 0.3s ease;
    }

    #quiz-container .checkbox-group {
      width: 100%;
      text-align: left;
      margin-bottom: 1em;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 20px;
      padding: 10px;
      box-sizing: border-box;
    }

    #quiz-container .checkbox-item {
      margin: 10px 0;
      display: flex;
      align-items: center;
    }

    #quiz-container .checkbox-item input {
      width: auto;
      margin-right: 10px;
      margin-bottom: 0;
    }

    #quiz-container .checkbox-item label {
      flex: 1;
      color: #000;
    }

    #quiz-container select option[disabled][selected] {
      display: none;
    }

    .style-select-container {
      width: 100%;
      margin-bottom: 1em;
    }

    .style-buttons-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 100%;
    }

    .style-button-row {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      justify-content: flex-end;
    }

    .style-button {
      width: 200px;
      padding: 14px 20px;
      font-size: 1.1em;
      border: none;
      border-radius: 25px;
      background-color: #5865F2;
      color: white;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .style-button.selected {
      background-color: #4CAF50;
    }

    .style-info-button {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background-color: #5865F2;
      color: white;
      border: none;
      font-size: 1.2em;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .style-tooltip {
      display: none;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px;
      border-radius: 10px;
      margin-top: 5px;
      font-size: 0.9em;
      width: 100%;
    }

    #messages {
      flex-grow: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
      padding-bottom: 10px;
    }

    .msg {
      padding: 10px 16px;
      border-radius: 20px;
      max-width: 45%;
      word-wrap: break-word;
      font-size: 1em;
      white-space: pre-wrap;
    }

    .user {
      background: rgba(240, 240, 240, 0.9);
      align-self: flex-end;
    }

    .ai {
      background: rgba(208, 240, 255, 0.9);
      align-self: flex-end;
    }

    #chat-form {
      display: flex;
      gap: 8px;
    }

    #chat-form input {
      flex-grow: 1;
      border-radius: 20px;
      padding: 10px;
      border: none;
      font-size: 1em;
      background: rgba(255,255,255,0.9);
      transition: all 0.3s ease;
    }

    #chat-form button {
      border: none;
      background-color: #5865F2;
      color: white;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      font-size: 1.2em;
      transition: all 0.3s ease;
    }

    #chat-form button:disabled {
      background: #ccc;
    }
  </style>
</head>
<body>
<div id="loader">–ó–∞–≥—Ä—É–∑–∫–∞ Duco AI...</div>
<div id="quiz-container" style="display:none;"></div>
<div id="chat-container" style="display:none;">
  <div id="messages"></div>
  <form id="chat-form">
    <input type="text" id="user-input" placeholder="–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off" required disabled />
    <button type="submit" disabled>‚û§</button>
  </form>
</div>

<script>
const SHEETS_API_URL = 'https://cold-credit-3c5d.arsivals.workers.dev/sheet';
const GEMINI_API_URL = 'https://cold-credit-3c5d.arsivals.workers.dev/gemini';

let userId = 'test_user';
let quizData = {};
let hasSentGreeting = false;
let selectedStyle = null;

const coachingStyles = {
  '–ñ–µ–ª–µ–∑–Ω—ã–π –ù–∞—Å—Ç–∞–≤–Ω–∏–∫': '–°—Ç—Ä–æ–≥–∏–π, –Ω–æ —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤—ã–π —Ç—Ä–µ–Ω–µ—Ä. –ë—É–¥–µ—Ç –¥–µ—Ä–∂–∞—Ç—å –≤–∞—Å –≤ —Ç–æ–Ω—É—Å–µ, –Ω–æ —Å –∑–∞–±–æ—Ç–æ–π –æ –≤–∞—à–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å–µ.',
  '–≠–Ω–µ—Ä–¥–∂–∞–π–∑–µ—Ä-–ó–∞–∂–∏–≥–∞–ª–∫–∞': '–ü–æ–∑–∏—Ç–∏–≤–Ω—ã–π –∏ –∑–∞—Ä—è–∂–∞—é—â–∏–π —ç–Ω–µ—Ä–≥–∏–µ–π. –ü–æ–º–æ–∂–µ—Ç –Ω–∞–π—Ç–∏ –º–æ—Ç–∏–≤–∞—Ü–∏—é –¥–∞–∂–µ –≤ —Å–∞–º—ã–µ –ª–µ–Ω–∏–≤—ã–µ –¥–Ω–∏.',
  '–°–ø–æ–∫–æ–π–Ω—ã–π –ú—É–¥—Ä–µ—Ü': '–ú—É–¥—Ä—ã–π –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π. –î–∞—Å—Ç —Å–æ–≤–µ—Ç—ã –∏ –ø–æ–º–æ–∂–µ—Ç –æ—Å–æ–∑–Ω–∞—Ç—å –≤–∞–∂–Ω–æ—Å—Ç—å —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫.',
  '–ê–ë–°–û–õ–Æ–¢–ù–´–ô –î–û–ú–ò–ù–ê–¢–û–†': '–ñ–µ—Å—Ç–∫–∏–π –∏ —Ç—Ä–µ–±–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π (—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π). –¢–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Ö, –∫—Ç–æ –≥–æ—Ç–æ–≤ –∫ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–µ.'
};

const quizSteps = [
  { 
    key: 'name', 
    text: '–ü—Ä–∏–≤–µ—Ç! –î–∞–≤–∞–π –∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è üòä –ö–∞–∫ —è –º–æ–≥—É –∫ —Ç–µ–±–µ –æ–±—Ä–∞—â–∞—Ç—å—Å—è?', 
    type: 'text' 
  },
  { 
    key: 'running_frequency', 
    text: (name) => `–û—á–µ–Ω—å –ø—Ä–∏—è—Ç–Ω–æ, ${name}! –†–∞–¥, —á—Ç–æ —Ç—ã –∑–¥–µ—Å—å, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –±–µ–≥ —á–∞—Å—Ç—å—é —Å–≤–æ–µ–π –∂–∏–∑–Ω–∏. –°–∫–∞–∂–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é —Ç—ã —Å—Ç—Ä–µ–º–∏—à—å—Å—è –∏–ª–∏ —Ö–æ—Ç–µ–ª–∞ –±—ã –≤—ã—Ö–æ–¥–∏—Ç—å –Ω–∞ –ø—Ä–æ–±–µ–∂–∫—É?`,
    type: 'select', 
    options: [
      {value: '1 —Ä–∞–∑', text: '1 —Ä–∞–∑'},
      {value: '2 —Ä–∞–∑–∞', text: '2 —Ä–∞–∑–∞'},
      {value: '3 —Ä–∞–∑–∞', text: '3 —Ä–∞–∑–∞'},
      {value: '–ë–æ–ª—å—à–µ 3 —Ä–∞–∑', text: '–ë–æ–ª—å—à–µ 3 —Ä–∞–∑'},
      {value: '–ü–æ–∫–∞ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–∏–ª—Å—è/–ª–∞—Å—å', text: '–ü–æ–∫–∞ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–∏–ª—Å—è/–ª–∞—Å—å'}
    ],
    placeholder: '–í—ã–±—Ä–∞—Ç—å'
  },
  { 
    key: 'preferred_days', 
    text: (name, data) => `–ü–æ–Ω—è–ª, ${name}! ${data.running_frequency} ‚Äì –æ—Ç–ª–∏—á–Ω–æ–µ –Ω–∞—á–∞–ª–æ –∏–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ! –ê –µ—Å—Ç—å –ª–∏ –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ç–µ–±–µ –æ–±—ã—á–Ω–æ —É–¥–æ–±–Ω–µ–µ –≤—Å–µ–≥–æ –¥–ª—è –±–µ–≥–∞? –ú–æ–∂–µ—à—å –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ.`,
    type: 'checkbox',
    options: [
      '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫',
      '–í—Ç–æ—Ä–Ω–∏–∫',
      '–°—Ä–µ–¥–∞',
      '–ß–µ—Ç–≤–µ—Ä–≥',
      '–ü—è—Ç–Ω–∏—Ü–∞',
      '–°—É–±–±–æ—Ç–∞',
      '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ',
      '–õ—é–±—ã–µ –¥–Ω–∏, –ø–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—é'
    ]
  },
  { 
    key: 'primary_motivation', 
    text: (name, data) => `${name}, —Ç–µ–ø–µ—Ä—å –Ω–µ–º–Ω–æ–≥–æ –æ —Ç–≤–æ–µ–π –º–æ—Ç–∏–≤–∞—Ü–∏–∏. –ß—Ç–æ –¥–ª—è —Ç–µ–±—è –≥–ª–∞–≤–Ω–æ–µ, –∫–æ–≥–¥–∞ —Ç—ã –¥—É–º–∞–µ—à—å –æ –±–µ–≥–µ? –ß—Ç–æ —Ç–µ–±—è –≤–¥–æ—Ö–Ω–æ–≤–ª—è–µ—Ç –∏–ª–∏ –∫–∞–∫—É—é —Ü–µ–ª—å –ø—Ä–µ—Å–ª–µ–¥—É–µ—à—å?`,
    type: 'checkbox',
    options: [
      '–ü–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å –ø—Ä–∏–ª–∏–≤ —ç–Ω–µ—Ä–≥–∏–∏ –∏ –±–æ–¥—Ä–æ—Å—Ç–∏',
      '–°–Ω—è—Ç—å —Å—Ç—Ä–µ—Å—Å –∏ —Ä–∞–∑–≥—Ä—É–∑–∏—Ç—å –≥–æ–ª–æ–≤—É',
      '–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∏–ª–∏ —É–ª—É—á—à–∏—Ç—å —Ñ–∏–∑–∏—á–µ—Å–∫—É—é —Ñ–æ—Ä–º—É',
      '–ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ —Å–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å',
      '–ü—Ä–æ—Å—Ç–æ –ø–æ–±—ã—Ç—å –Ω–∞ —Å–≤–µ–∂–µ–º –≤–æ–∑–¥—É—Ö–µ –∏ –ø–æ–¥–≤–∏–≥–∞—Ç—å—Å—è',
      '–£–ª—É—á—à–∏—Ç—å –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å'
    ],
    otherOption: true
  },
  { 
    key: 'overcome_triggers', 
    text: (name, data) => `–≠—Ç–æ –∑–Ω–∞–∫–æ–º—ã–µ –º–Ω–æ–≥–∏–º —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏! –ê –∫–æ–≥–¥–∞ —Ç—ã —Å—Ç–∞–ª–∫–∏–≤–∞–µ—à—å—Å—è —Å —Ç–∞–∫–∏–º –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, —É—Å—Ç–∞–ª–æ—Å—Ç—å—é –∏–ª–∏ –ª–µ–Ω—å—é), –µ—Å—Ç—å –ª–∏ —á—Ç–æ-—Ç–æ, —á—Ç–æ –æ–±—ã—á–Ω–æ –ø–æ–º–æ–≥–∞–µ—Ç —Ç–µ–±–µ –≤—Å–µ-—Ç–∞–∫–∏ —Å–æ–±—Ä–∞—Ç—å—Å—è –∏ –ø–æ–±–µ–∂–∞—Ç—å? –¢–≤–æ–∏ –ª–∏—á–Ω—ã–µ "–ª–∞–π—Ñ—Ö–∞–∫–∏"?`,
    type: 'checkbox',
    options: [
      '–í–∫–ª—é—á–∏—Ç—å –ª—é–±–∏–º—É—é —ç–Ω–µ—Ä–≥–∏—á–Ω—É—é –º—É–∑—ã–∫—É',
      '–ü–æ–¥—É–º–∞—Ç—å –æ –ø—Ä–∏—è—Ç–Ω–æ–º —á—É–≤—Å—Ç–≤–µ –ø–æ—Å–ª–µ –ø—Ä–æ–±–µ–∂–∫–∏',
      '–î–∞–Ω–Ω–æ–µ —Å–µ–±–µ –æ–±–µ—â–∞–Ω–∏–µ –∏–ª–∏ —Ü–µ–ª—å',
      '–ü—Ä–æ—Å—Ç–æ –Ω–∞—á–∞—Ç—å, –Ω–µ –¥—É–º–∞—è, –∞ —Ç–∞–º –≤—Ç—è–Ω—É—Å—å',
      '–î–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å —Å –∫–µ–º-—Ç–æ –∏–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –±–ª–∏–∑–∫–∏—Ö'
    ],
    otherOption: true
  },
  { 
    key: 'coaching_style', 
    text: (name, data) => `–°–ø–∞—Å–∏–±–æ –∑–∞ —á–µ—Å—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã, ${name}! –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç AI-–∫–æ—É—á—É —Ç–µ–±—è –ø–æ–Ω–∏–º–∞—Ç—å. –ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–æ–ø—Ä–æ—Å: –ø—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ AI-–∫–æ—É—á ‚Äì —ç—Ç–æ —Ç–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –º–æ—Ç–∏–≤–∞—Ç–æ—Ä –¥–ª—è –±–µ–≥–∞. –ö–∞–∫–æ–π —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è —Ç–µ–±–µ –±–ª–∏–∂–µ?`,
    type: 'custom-select',
    options: Object.keys(coachingStyles)
  }
];

function getBackgroundByStyle(style) {
  const map = {
    '–ñ–µ–ª–µ–∑–Ω—ã–π –ù–∞—Å—Ç–∞–≤–Ω–∏–∫': 'bg/iron.jpg',
    '–≠–Ω–µ—Ä–¥–∂–∞–π–∑–µ—Ä-–ó–∞–∂–∏–≥–∞–ª–∫–∞': 'bg/energizer.jpg',
    '–°–ø–æ–∫–æ–π–Ω—ã–π –ú—É–¥—Ä–µ—Ü': 'bg/sage.jpg',
    '–ê–ë–°–û–õ–Æ–¢–ù–´–ô –î–û–ú–ò–ù–ê–¢–û–†': 'bg/dominator.jpg'
  };
  return map[style] || 'bg/default.jpg';
}

function setBackgroundImage(style) {
  const url = getBackgroundByStyle(style);
  document.body.style.setProperty('--bg-url', `url(${url})`);
}

function typeText(el, text, speed = 20) {
  let i = 0;
  el.textContent = '';
  const interval = setInterval(() => {
    if (i < text.length) {
      el.textContent += text[i];
      el.parentElement.scrollTop = el.parentElement.scrollHeight;
      i++;
    } else {
      clearInterval(interval);
    }
  }, speed);
}

async function fetchUserData() {
  const res = await fetch(`${SHEETS_API_URL}?user_id=${userId}`);
  const json = await res.json();
  return json?.data || null;
}

async function saveQuizData(data) {
  const res = await fetch(SHEETS_API_URL, {
    method: 'POST',
    body: JSON.stringify({ user_id: userId, ...data }),
    headers: { 'Content-Type': 'application/json' }
  });
  return await res.json();
}

async function sendMessageToAI(userMessage, isFirst = false) {
  const profileText = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${quizData.name}, –±–µ–≥–∞–µ—Ç ${quizData.running_frequency}, —É–¥–æ–±–Ω—ã–µ –¥–Ω–∏: ${quizData.preferred_days}, –º–æ—Ç–∏–≤–∞—Ü–∏—è: ${quizData.primary_motivation}, —Ç—Ä–∏–≥–≥–µ—Ä—ã: ${quizData.overcome_triggers}, —Å—Ç–∏–ª—å: ${quizData.coaching_style}`;
  const history = (quizData.last_messages || []).concat([{ role: 'user', text: userMessage }]);
  let prompt = `${profileText}\n\n–ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞:\n`;
  history.forEach(m => {
    prompt += (m.role === 'user' ? '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ' : 'AI: ') + m.text + '\n';
  });
  
  if (isFirst && !hasSentGreeting) {
    prompt += `–û—Ç–≤–µ—Ç—å –æ—Ç –º—É–∂—Å–∫–æ–≥–æ –∏–º–µ–Ω–∏. –ü–æ–∑–¥—Ä–∞–≤—å —á—Ç–æ –æ–Ω –≤–º–µ—Å—Ç–µ —Å Duco AI. –ó–∞–¥–∞–π –ø–æ–ª–µ–∑–Ω—ã–µ –∏ –≤–æ–æ–¥—É—à–µ–≤–ª—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã: –∫–æ–≥–¥–∞ –ø–ª–∞–Ω–∏—Ä—É–µ—à—å –Ω–∞—á–∞—Ç—å –±–µ–≥–∞—Ç—å? –≥–¥–µ —Ö–æ—á–µ—à—å –±–µ–≥–∞—Ç—å (—É–ª–∏—Ü–∞, —Å—Ç–∞–¥–∏–æ–Ω)? –∫–∞–∫–∏–µ —É —Ç–µ–±—è —Ü–µ–ª–∏ ‚Äî –≤–µ—Å, —Ñ–æ—Ä–º–∞, –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞? –ü–∏—à–∏ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ, –∫–æ—Ä–æ—Ç–∫–æ (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è).`;
    hasSentGreeting = true;
  } else {
    prompt += '–û—Ç–≤–µ—Ç—å –∫—Ä–∞—Ç–∫–æ –æ—Ç –º—É–∂—Å–∫–æ–≥–æ –∏–º–µ–Ω–∏, –ø–æ–Ω—è—Ç–Ω–æ –∏ —Å –∑–∞–±–æ—Ç–æ–π. –ü—Ä–µ–¥–ª–æ–∂–∏ —á—Ç–æ-—Ç–æ. –†–∞—Å–∫—Ä–æ–π –µ–≥–æ –º—ã—Å–ª—å. –ù–µ –±–æ–ª—å—à–µ 4-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π.';
  }
  
  const res = await fetch(GEMINI_API_URL, {
    method: 'POST',
    body: JSON.stringify({ prompt }),
    headers: { 'Content-Type': 'application/json' }
  });
  const json = await res.json();
  return json?.response || '–û—Ç–≤–µ—Ç –æ—Ç Duco AI –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
}

function showStep(i) {
  setBackgroundImage('default');
  const container = document.getElementById('quiz-container');
  const step = quizSteps[i];
  
  let questionText = typeof step.text === 'function' 
    ? step.text(quizData.name || '', quizData) 
    : step.text;
  
  container.style.display = 'flex';
  container.innerHTML = `<h3>${questionText}</h3>`;
  
  let inputHtml = '';
  
  if (step.type === 'text') {
    inputHtml = `<input id="input" required />`;
  } 
  else if (step.type === 'select') {
    inputHtml = `
      <select id="input" required>
        <option value="" disabled selected>${step.placeholder || '–í—ã–±—Ä–∞—Ç—å'}</option>
        ${step.options.map(o => 
          `<option value="${o.value}">${o.text || o}</option>`
        ).join('')}
      </select>
    `;
  }
  else if (step.type === 'checkbox') {
    inputHtml = `
      <div class="checkbox-group">
        ${step.options.map((option, idx) => `
          <div class="checkbox-item">
            <input type="checkbox" id="option-${idx}" value="${option}">
            <label for="option-${idx}">${option}</label>
          </div>
        `).join('')}
        ${step.otherOption ? `
          <div style="margin-top: 10px;">
            <input type="text" id="other-input" placeholder="–î—Ä—É–≥–æ–µ (–Ω–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç)" style="width: 100%; padding: 10px; box-sizing: border-box;">
          </div>
        ` : ''}
      </div>
    `;
  }
  else if (step.type === 'custom-select') {
    inputHtml = `
      <div class="style-select-container">
        <div class="style-buttons-container">
          ${step.options.map(style => `
            <div>
              <div class="style-button-row">
                <button class="style-button" data-style="${style}" onclick="selectStyle('${style}')">${style}</button>
                <button class="style-info-button" onclick="showStyleTooltip('${style}')">i</button>
              </div>
              <div id="tooltip-${style}" class="style-tooltip">
                ${coachingStyles[style]}
              </div>
            </div>
          `).join('')}
        </div>
        <input type="hidden" id="style-input" value="">
      </div>
    `;
  }
  
  container.innerHTML += inputHtml + `<button id="next" ${step.type === 'checkbox' || step.type === 'custom-select' ? 'disabled' : ''}>–î–∞–ª–µ–µ</button>`;
  
  const nextBtn = document.getElementById('next');
  const input = step.type === 'checkbox' ? null : document.getElementById('input');
  
  if (step.type === 'checkbox') {
    const checkboxes = container.querySelectorAll('input[type="checkbox"]');
    const otherInput = container.querySelector('#other-input');
    
    const updateNextBtn = () => {
      const anyChecked = Array.from(checkboxes).some(cb => cb.checked) || 
                       (otherInput && otherInput.value.trim() !== '');
      nextBtn.disabled = !anyChecked;
    };
    
    checkboxes.forEach(cb => {
      cb.addEventListener('change', updateNextBtn);
    });
    
    if (otherInput) {
      otherInput.addEventListener('input', updateNextBtn);
    }
  } else if (input) {
    input.addEventListener('input', () => {
      nextBtn.disabled = input.value.trim() === '';
    });
    input.focus();
  }
  
  nextBtn.onclick = () => {
    let val;
    
    if (step.type === 'checkbox') {
      const selected = Array.from(container.querySelectorAll('input[type="checkbox"]:checked'))
        .map(cb => cb.value);
      if (step.otherOption) {
        const otherVal = container.querySelector('#other-input')?.value.trim();
        if (otherVal) selected.push(otherVal);
      }
      val = selected.join(', ');
    } else if (step.type === 'custom-select') {
      val = selectedStyle;
      if (!val) return;
    } else {
      val = input.value.trim();
    }
    
    if (!val && step.type !== 'checkbox') return;
    
    quizData[step.key] = val;
    
    if (i + 1 < quizSteps.length) {
      showStep(i + 1);
    } else {
      finishQuiz();
    }
  };
}

function selectStyle(style) {
  selectedStyle = style;
  document.getElementById('next').disabled = false;
  
  // –°–±—Ä–æ—Å –≤—ã–¥–µ–ª–µ–Ω–∏—è –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
  const buttons = document.querySelectorAll('.style-button');
  buttons.forEach(btn => {
    btn.classList.remove('selected');
  });
  
  // –í—ã–¥–µ–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–Ω–æ–ø–∫–∏
  const selectedButton = document.querySelector(`.style-button[data-style="${style}"]`);
  if (selectedButton) {
    selectedButton.classList.add('selected');
  }
}

function showStyleTooltip(style) {
  const tooltip = document.getElementById(`tooltip-${style}`);
  tooltip.style.display = tooltip.style.display === 'block' ? 'none' : 'block';
}

async function finishQuiz() {
  document.getElementById('quiz-container').style.display = 'none';
  document.getElementById('loader').style.display = 'flex';
  
  try {
    quizData.last_messages = [];
    quizData.last_greet_ts = new Date().toISOString();
    quizData.signup_date = new Date().toISOString();
    
    const saveResult = await saveQuizData(quizData);
    console.log('–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã:', saveResult);
    
    document.getElementById('chat-container').style.display = 'flex';
    document.getElementById('loader').style.display = 'none';
    
    const userData = await fetchUserData();
    if (userData && userData.last_messages) {
      quizData.last_messages = userData.last_messages;
    }
    
    initChat(quizData);
    
    if (quizData.last_messages.length === 0) {
      sendGreetingMessage();
    } else {
      restoreChatHistory();
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∫–≤–∏–∑–∞:', error);
    document.getElementById('loader').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.';
  }
}

function restoreChatHistory() {
  const messagesDiv = document.getElementById('messages');
  messagesDiv.innerHTML = '';
  
  quizData.last_messages.forEach(msg => {
    const msgDiv = document.createElement('div');
    msgDiv.className = `msg ${msg.role === 'user' ? 'user' : 'ai'}`;
    msgDiv.textContent = msg.text;
    messagesDiv.appendChild(msgDiv);
  });
  
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function initChat(userData) {
  const messagesDiv = document.getElementById('messages');
  const chatForm = document.getElementById('chat-form');
  const input = document.getElementById('user-input');
  const button = chatForm.querySelector('button');

  quizData = userData;
  setBackgroundImage(quizData.coaching_style);

  input.disabled = false;
  button.disabled = true;

  input.addEventListener('input', () => {
    button.disabled = input.value.trim() === '';
  });

  chatForm.onsubmit = async (e) => {
    e.preventDefault();
    const text = input.value.trim();
    if (!text) return;

    const userMsgDiv = document.createElement('div');
    userMsgDiv.className = 'msg user';
    userMsgDiv.textContent = text;
    messagesDiv.appendChild(userMsgDiv);
    
    input.value = '';
    button.disabled = true;
    messagesDiv.scrollTop = messagesDiv.scrollHeight;

    const aiMsgDiv = document.createElement('div');
    aiMsgDiv.className = 'msg ai';
    aiMsgDiv.textContent = '...';
    messagesDiv.appendChild(aiMsgDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;

    try {
      const reply = await sendMessageToAI(text);
      
      typeText(aiMsgDiv, reply);
      
      const updatedMessages = [
        ...(quizData.last_messages || []), 
        { role: 'user', text }, 
        { role: 'ai', text: reply }
      ].slice(-15);
      
      quizData.last_messages = updatedMessages;
      await saveQuizData(quizData);
    } catch (error) {
      aiMsgDiv.textContent = '–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.';
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
    }
  };
}

async function sendGreetingMessage() {
  const messagesDiv = document.getElementById('messages');
  
  const aiMsgDiv = document.createElement('div');
  aiMsgDiv.className = 'msg ai';
  aiMsgDiv.textContent = '...';
  messagesDiv.appendChild(aiMsgDiv);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;

  try {
    const reply = await sendMessageToAI('–ü—Ä–∏–≤–µ—Ç! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—à—ë–ª –∫–≤–∏–∑, –Ω–∞—á–Ω–∏ –±–µ—Å–µ–¥—É.', true);
    
    typeText(aiMsgDiv, reply);
    
    quizData.last_messages = [{ role: 'ai', text: reply }];
    await saveQuizData(quizData);
  } catch (error) {
    aiMsgDiv.textContent = '–ü—Ä–∏–≤–µ—Ç! –î–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω–µ–º –Ω–∞—à–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ –≤ –º–∏—Ä –±–µ–≥–∞!';
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è:', error);
  }
}

async function startChat(skipGreeting = false, localQuizData = null) {
  try {
    let userData = localQuizData;
    if (!userData) {
      userData = await fetchUserData();
    }

    if (!userData || !userData.name || !userData.running_frequency) {
      document.getElementById('loader').style.display = 'none';
      document.getElementById('quiz-container').style.display = 'flex';
      return showStep(0);
    }

    quizData = userData;
    setBackgroundImage(quizData.coaching_style);

    document.getElementById('chat-container').style.display = 'flex';
    document.getElementById('loader').style.display = 'none';
    
    initChat(userData);
    
    if (userData.last_messages && userData.last_messages.length > 0) {
      restoreChatHistory();
    } else if (!skipGreeting) {
      sendGreetingMessage();
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —á–∞—Ç–∞:', error);
    document.getElementById('loader').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.';
  }
}

document.addEventListener('DOMContentLoaded', async () => {
  try {
    if (window.Telegram && Telegram.WebApp?.initDataUnsafe?.user?.id) {
      Telegram.WebApp.ready();
      userId = Telegram.WebApp.initDataUnsafe.user.id.toString();
    }
    await startChat(true);
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
    document.getElementById('loader').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.';
  }
});
</script>
</body>
</html>