<!-- index.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Healthie Quiz</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 600px;
      margin: 0 auto;
      background: #f5f5f5;
    }
    #question {
      font-size: 1.5rem;
      margin-bottom: 20px;
      color: #0088cc;
    }
    #answers {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    button {
      padding: 12px;
      background: #0088cc;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.3s;
    }
    button:hover {
      background: #006699;
    }
    input {
      padding: 12px;
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0,0,0,.3);
      border-radius: 50%;
      border-top-color: #0088cc;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    #chat-container {
      display: none;
      margin-top: 20px;
    }
    .message {
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 8px;
      max-width: 80%;
    }
    .ai-message {
      background: #e3f2fd;
      align-self: flex-start;
    }
    .user-message {
      background: #dcf8c6;
      align-self: flex-end;
      margin-left: auto;
    }
    #chat-messages {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 15px;
      padding: 10px;
      background: white;
      border-radius: 8px;
    }
    #user-input {
      display: flex;
      gap: 10px;
    }
    #user-message {
      flex-grow: 1;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ddd;
    }
    #send-button {
      min-width: 100px;
    }
  </style>
</head>
<body>
  <div id="quiz">
    <h1 id="question"></h1>
    <input type="text" id="text-answer" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç..." style="display: none;" />
    <div id="answers"></div>
  </div>

  <div id="chat-container">
    <div id="chat-messages"></div>
    <div id="user-input">
      <input type="text" id="user-message" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
      <button id="send-button">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const quiz = [
      { question: "!–î–∞–≤–∞–π –∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è! –ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?", type: "text", key: "name" },
      { question: "–°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é —Ç—ã —Ö–æ—á–µ—à—å –±–µ–≥–∞—Ç—å?", type: "choice", options: ["1 —Ä–∞–∑", "2 —Ä–∞–∑–∞", "3 —Ä–∞–∑–∞", "–ë–æ–ª—å—à–µ 3 —Ä–∞–∑"], key: "frequency" },
      { question: "–ß—Ç–æ —Ç–µ–±—è –º–æ—Ç–∏–≤–∏—Ä—É–µ—Ç?", type: "choice", options: ["–ü–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å –ø—Ä–∏–ª–∏–≤ —ç–Ω–µ—Ä–≥–∏–∏", "–°–Ω—è—Ç—å —Å—Ç—Ä–µ—Å—Å", "–£–ª—É—á—à–∏—Ç—å —Ñ–∏–∑–∏—á–µ—Å–∫—É—é —Ñ–æ—Ä–º—É", "–î—Ä—É–≥–æ–µ (–Ω–∞–ø–∏—à—É)"], key: "motivation" },
      { question: "–í—ã–±–µ—Ä–∏ —Å—Ç–∏–ª—å –∫–æ—É—á–∞:", type: "style", options: ["–ñ–µ–ª–µ–∑–Ω—ã–π –ù–∞—Å—Ç–∞–≤–Ω–∏–∫", "–≠–Ω–µ—Ä–¥–∂–∞–π–∑–µ—Ä-–ó–∞–∂–∏–≥–∞–ª–∫–∞", "–°–ø–æ–∫–æ–π–Ω—ã–π –ú—É–¥—Ä–µ—Ü", "–ê–ë–°–û–õ–Æ–¢–ù–´–ô –î–û–ú–ò–ù–ê–¢–û–† (–±—É–¥–µ—Ç –∂–µ—Å—Ç–∫–æ!)"], key: "style" }
    ];

    let currentStep = 0;
    const userData = {};

    function showQuestion() {
      const step = quiz[currentStep];
      document.getElementById("question").textContent = step.question;
      const answersDiv = document.getElementById("answers");
      answersDiv.innerHTML = "";

      if (step.type === "text") {
        document.getElementById("text-answer").style.display = "block";
        document.getElementById("text-answer").value = "";
        document.getElementById("text-answer").focus();
      } else {
        document.getElementById("text-answer").style.display = "none";
        step.options.forEach(option => {
          const button = document.createElement("button");
          button.textContent = option;
          button.onclick = () => {
            button.innerHTML = `<span class="loading"></span> ${option}`;
            setTimeout(() => saveAnswer(option), 300);
          };
          answersDiv.appendChild(button);
        });
      }
    }

    function saveAnswer(answer) {
      const step = quiz[currentStep];
      userData[step.key] = answer;
      currentStep++;
      if (currentStep < quiz.length) showQuestion();
      else finishQuiz();
    }

    async function generateWithAI(prompt) {
      try {
        const response = await fetch("/api/proxy", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            prompt: `–¢—ã ‚Äî ${userData.style}, –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ç—Ä–µ–Ω–µ—Ä –ø–æ –±–µ–≥—É. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${userData.name}, —Ü–µ–ª—å: ${userData.frequency} –ø—Ä–æ–±–µ–∂–µ–∫ –≤ –Ω–µ–¥–µ–ª—é. –ú–æ—Ç–∏–≤–∞—Ü–∏—è: ${userData.motivation}. –û—Ç–≤–µ—Ç—å –∫—Ä–∞—Ç–∫–æ (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) –≤ —Å–≤–æ—ë–º —Å—Ç–∏–ª–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å: ${prompt}`,
            stream: false
          })
        });
        const data = await response.json();
        return data.response || data.text || "–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç...";
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ø—Ä–æ–∫—Å–∏:", error);
        const fallback = {
          "–ñ–µ–ª–µ–∑–Ω—ã–π –ù–∞—Å—Ç–∞–≤–Ω–∏–∫": `${userData.name}, –±–µ–≥–∏ –±–µ–∑ –≤–æ–ø—Ä–æ—Å–æ–≤!`,
          "–≠–Ω–µ—Ä–¥–∂–∞–π–∑–µ—Ä-–ó–∞–∂–∏–≥–∞–ª–∫–∞": `–î–∞–≤–∞–π, ${userData.name}, —Ç—ã —Å–º–æ–∂–µ—à—å! üí™`,
          "–°–ø–æ–∫–æ–π–Ω—ã–π –ú—É–¥—Ä–µ—Ü": "–ë–µ–≥ ‚Äî —ç—Ç–æ –ø—É—Ç—å –∫ –≥–∞—Ä–º–æ–Ω–∏–∏.",
          "–ê–ë–°–û–õ–Æ–¢–ù–´–ô –î–û–ú–ò–ù–ê–¢–û–†": "–ë–ï–ì–ò –ò–õ–ò –£–ú–†–ò!"
        };
        return fallback[userData.style] || "–î–∞–≤–∞–π –æ–±—Å—É–¥–∏–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.";
      }
    }

    function addMessage(sender, text) {
      const chatDiv = document.getElementById("chat-messages");
      const messageDiv = document.createElement("div");
      messageDiv.className = `message ${sender}-message`;
      messageDiv.textContent = text;
      chatDiv.appendChild(messageDiv);
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    async function finishQuiz() {
      document.getElementById("quiz").innerHTML = `<h1>–§–æ—Ä–º–∏—Ä—É–µ–º –≤–∞—à –ø–ª–∞–Ω...</h1><div style="text-align: center;"><span class="loading" style="width: 40px; height: 40px;"></span></div>`;
      const welcome = await generateWithAI("–ù–∞–ø–∏—à–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ");
      document.getElementById("quiz").style.display = "none";
      document.getElementById("chat-container").style.display = "block";
      addMessage("ai", welcome);
    }

    document.getElementById("send-button").addEventListener("click", async () => {
      const input = document.getElementById("user-message");
      const message = input.value.trim();
      if (!message) return;
      addMessage("user", message);
      input.value = "";
      const typing = document.createElement("div");
      typing.className = "message ai-message";
      typing.innerHTML = '<span class="loading"></span> –ö–æ—É—á –ø–µ—á–∞—Ç–∞–µ—Ç...';
      document.getElementById("chat-messages").appendChild(typing);
      const response = await generateWithAI(message);
      document.getElementById("chat-messages").removeChild(typing);
      addMessage("ai", response);
    });

    document.getElementById("user-message").addEventListener("keypress", e => {
      if (e.key === "Enter") document.getElementById("send-button").click();
    });

    document.getElementById("text-answer").addEventListener("keypress", e => {
      if (e.key === "Enter" && e.target.value.trim()) saveAnswer(e.target.value.trim());
    });

    showQuestion();
  </script>
</body>
</html>