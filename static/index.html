<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Duco AI</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  html, body {
    margin: 0; padding: 0; height: 100%; font-family: sans-serif; overflow: hidden; -webkit-overflow-scrolling: touch;
  }
  body::before {
    content: '';
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background-image: var(--bg-url, url('bg/default.jpg'));
    background-size: cover; background-position: center; background-repeat: no-repeat;
    z-index: -1;
  }
  #loader {
    display: flex; justify-content: center; align-items: center; height: 100vh;
    font-size: 1.2em; color: #fff; backdrop-filter: blur(6px);
  }
  #quiz-container, #chat-container {
    max-width: 500px; margin: auto; height: 100vh;
    display: flex; flex-direction: column; box-sizing: border-box; padding: 1em; background: transparent;
  }
  #quiz-container {
    justify-content: center; align-items: center; text-align: center; transition: all 0.3s ease-in-out;
  }
  #quiz-container h3 {
    font-size: 1.4em; color: #fff; margin-bottom: 1em; max-width: 90%;
  }
  #quiz-container input, #quiz-container select {
    width: 100%; padding: 14px; font-size: 1.1em; border-radius: 20px; border: none;
    margin-bottom: 1em; background: rgba(255, 255, 255, 0.9); color: #000; transition: all 0.3s ease;
  }
  #quiz-container button {
    padding: 14px 20px; font-size: 1.1em; border: none; border-radius: 25px;
    background-color: #5865F2; color: white; width: 100%; transition: all 0.3s ease;
  }
  #quiz-container .multi-select {
    display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 1em;
  }
  #quiz-container .multi-select button {
    padding: 10px 15px; border-radius: 20px; border: none; background: rgba(255,255,255,0.9);
    color: #000; cursor: pointer; font-size: 1em;
    transition: background-color 0.2s ease;
  }
  #quiz-container .multi-select button.selected {
    background-color: #5865F2; color: white;
  }
  #messages {
    flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column;
    align-items: flex-end; gap: 8px; padding-bottom: 10px;
  }
  .msg {
    padding: 10px 16px; border-radius: 20px; max-width: 45%; word-wrap: break-word;
    font-size: 1em; white-space: pre-wrap;
  }
  .user {
      background: rgba(240, 240, 240, 0.9);
      align-self: flex-end;
    }
  .ai {
      background: rgba(208, 240, 255, 0.9);
      align-self: flex-end;
    }
  #chat-form input {
    flex-grow: 1; border-radius: 20px; padding: 10px; border: none; font-size: 1em;
    background: rgba(255,255,255,0.9); transition: all 0.3s ease;
  }
  #chat-form button {
    border: none; background-color: #5865F2; color: white; border-radius: 50%;
    width: 44px; height: 44px; font-size: 1.2em; transition: all 0.3s ease;
  }
  #chat-form button:disabled {
    background: #ccc;
  }
</style>
</head>
<body>
<div id="loader">–ó–∞–≥—Ä—É–∑–∫–∞ Duco AI...</div>
<div id="quiz-container" style="display:none;"></div>
<div id="chat-container" style="display:none;">
  <div id="messages"></div>
  <form id="chat-form">
    <input type="text" id="user-input" placeholder="–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off" required disabled />
    <button type="submit" disabled>‚û§</button>
  </form>
</div>

<script>
const SHEETS_API_URL = 'https://cold-credit-3c5d.arsivals.workers.dev/sheet';
const GEMINI_API_URL = 'https://cold-credit-3c5d.arsivals.workers.dev/gemini';

let userId = 'test_user';
let quizData = {};
let currentStep = 0;

// –ö–≤–∏–∑ —à–∞–≥–∏ - —Ç–µ–ø–µ—Ä—å –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –ø–æ –¢–ó
const quizSteps = [
  {
    key: 'name',
    text: '–ü—Ä–∏–≤–µ—Ç! –î–∞–≤–∞–π –∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è üòä –ö–∞–∫ —è –º–æ–≥—É –∫ —Ç–µ–±–µ –æ–±—Ä–∞—â–∞—Ç—å—Å—è?',
    type: 'text'
  },
  {
    key: 'running_frequency',
    textFunc: name => `–û—á–µ–Ω—å –ø—Ä–∏—è—Ç–Ω–æ, ${name}! –†–∞–¥, —á—Ç–æ —Ç—ã –∑–¥–µ—Å—å, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –±–µ–≥ —á–∞—Å—Ç—å—é —Å–≤–æ–µ–π –∂–∏–∑–Ω–∏.\n\n–°–∫–∞–∂–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é —Ç—ã —Å—Ç—Ä–µ–º–∏—à—å—Å—è –∏–ª–∏ —Ö–æ—Ç–µ–ª–∞ –±—ã –≤—ã—Ö–æ–¥–∏—Ç—å –Ω–∞ –ø—Ä–æ–±–µ–∂–∫—É?`,
    type: 'select',
    options: ['1 —Ä–∞–∑', '2 —Ä–∞–∑–∞', '3 —Ä–∞–∑–∞', '–ë–æ–ª—å—à–µ 3 —Ä–∞–∑', '–ü–æ–∫–∞ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–∏–ª—Å—è/–ª–∞—Å—å']
  },
  {
    key: 'preferred_days',
    textFunc: name => `${name}, –ø–æ–Ω—è–ª–∞! –ê –µ—Å—Ç—å –ª–∏ –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ç–µ–±–µ –æ–±—ã—á–Ω–æ —É–¥–æ–±–Ω–µ–µ –≤—Å–µ–≥–æ –¥–ª—è –±–µ–≥–∞? –ú–æ–∂–µ—à—å –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ.`,
    type: 'multiselect',
    options: ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞', '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ', '–õ—é–±—ã–µ –¥–Ω–∏, –ø–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—é']
  },
  {
    key: 'primary_motivation',
    textFunc: name => `${name}, —Ç–µ–ø–µ—Ä—å –Ω–µ–º–Ω–æ–≥–æ –æ —Ç–≤–æ–µ–π –º–æ—Ç–∏–≤–∞—Ü–∏–∏. –ß—Ç–æ –¥–ª—è —Ç–µ–±—è –≥–ª–∞–≤–Ω–æ–µ, –∫–æ–≥–¥–∞ —Ç—ã –¥—É–º–∞–µ—à—å –æ –±–µ–≥–µ? –ß—Ç–æ —Ç–µ–±—è –≤–¥–æ—Ö–Ω–æ–≤–ª—è–µ—Ç –∏–ª–∏ –∫–∞–∫—É—é —Ü–µ–ª—å –ø—Ä–µ—Å–ª–µ–¥—É–µ—à—å?`,
    type: 'select',
    options: [
      '–ü–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å –ø—Ä–∏–ª–∏–≤ —ç–Ω–µ—Ä–≥–∏–∏ –∏ –±–æ–¥—Ä–æ—Å—Ç–∏',
      '–°–Ω—è—Ç—å —Å—Ç—Ä–µ—Å—Å –∏ —Ä–∞–∑–≥—Ä—É–∑–∏—Ç—å –≥–æ–ª–æ–≤—É',
      '–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∏–ª–∏ —É–ª—É—á—à–∏—Ç—å —Ñ–∏–∑–∏—á–µ—Å–∫—É—é —Ñ–æ—Ä–º—É',
      '–ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ —Å–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å',
      '–ü—Ä–æ—Å—Ç–æ –ø–æ–±—ã—Ç—å –Ω–∞ —Å–≤–µ–∂–µ–º –≤–æ–∑–¥—É—Ö–µ –∏ –ø–æ–¥–≤–∏–≥–∞—Ç—å—Å—è',
      '–£–ª—É—á—à–∏—Ç—å –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å',
      '–î—Ä—É–≥–æ–µ (–Ω–∞–ø–∏—à—É —Ç–µ–∫—Å—Ç–æ–º)'
    ],
    withTextInput: true
  },
  {
    key: 'main_obstacles',
    textFunc: name => `${name}, –∞ –∫–æ–≥–¥–∞ —Å—Ç–∞–ª–∫–∏–≤–∞–µ—à—å—Å—è —Å —Ç—Ä—É–¥–Ω–æ—Å—Ç—è–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —É—Å—Ç–∞–ª–æ—Å—Ç—å—é –∏–ª–∏ –ª–µ–Ω—å—é), —á—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç —Ç–µ–±–µ —Å–æ–±—Ä–∞—Ç—å—Å—è –∏ –ø–æ–±–µ–∂–∞—Ç—å? –¢–≤–æ–∏ –ª–∏—á–Ω—ã–µ "–ª–∞–π—Ñ—Ö–∞–∫–∏"?`,
    type: 'select',
    options: [
      '–í–∫–ª—é—á–∏—Ç—å –ª—é–±–∏–º—É—é —ç–Ω–µ—Ä–≥–∏—á–Ω—É—é –º—É–∑—ã–∫—É',
      '–ü–æ–¥—É–º–∞—Ç—å –æ –ø—Ä–∏—è—Ç–Ω–æ–º —á—É–≤—Å—Ç–≤–µ –ø–æ—Å–ª–µ –ø—Ä–æ–±–µ–∂–∫–∏',
      '–î–∞–Ω–Ω–æ–µ —Å–µ–±–µ –æ–±–µ—â–∞–Ω–∏–µ –∏–ª–∏ —Ü–µ–ª—å',
      '–ü—Ä–æ—Å—Ç–æ –Ω–∞—á–∞—Ç—å, –Ω–µ –¥—É–º–∞—è, –∞ —Ç–∞–º –≤—Ç—è–Ω—É—Å—å',
      '–î–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å —Å –∫–µ–º-—Ç–æ –∏–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –±–ª–∏–∑–∫–∏—Ö',
      '–î—Ä—É–≥–æ–µ (–Ω–∞–ø–∏—à—É —Ç–µ–∫—Å—Ç–æ–º)'
    ],
    withTextInput: true
  },
  {
    key: 'coaching_style',
    textFunc: name => `${name}, –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–æ–ø—Ä–æ—Å: –ø—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ AI-–∫–æ—É—á ‚Äî —ç—Ç–æ —Ç–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –º–æ—Ç–∏–≤–∞—Ç–æ—Ä –¥–ª—è –±–µ–≥–∞. –ö–∞–∫–æ–π —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è —Ç–µ–±–µ –±–ª–∏–∂–µ? –Ø –º–æ–≥—É –±—ã—Ç—å:`,
    type: 'select',
    options: ['–ñ–µ–ª–µ–∑–Ω—ã–π –ù–∞—Å—Ç–∞–≤–Ω–∏–∫', '–≠–Ω–µ—Ä–¥–∂–∞–π–∑–µ—Ä-–ó–∞–∂–∏–≥–∞–ª–∫–∞', '–°–ø–æ–∫–æ–π–Ω—ã–π –ú—É–¥—Ä–µ—Ü', '–ê–ë–°–û–õ–Æ–¢–ù–´–ô –î–û–ú–ò–ù–ê–¢–û–†'],
    warningForLast: true
  }
];

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–º–µ–Ω—ã —Ñ–æ–Ω–∞
function getBackgroundByStyle(style) {
  const map = {
    '–ñ–µ–ª–µ–∑–Ω—ã–π –ù–∞—Å—Ç–∞–≤–Ω–∏–∫': 'bg/iron.jpg',
    '–≠–Ω–µ—Ä–¥–∂–∞–π–∑–µ—Ä-–ó–∞–∂–∏–≥–∞–ª–∫–∞': 'bg/energizer.jpg',
    '–°–ø–æ–∫–æ–π–Ω—ã–π –ú—É–¥—Ä–µ—Ü': 'bg/sage.jpg',
    '–ê–ë–°–û–õ–Æ–¢–ù–´–ô –î–û–ú–ò–ù–ê–¢–û–†': 'bg/dominator.jpg'
  };
  return map[style] || 'bg/default.jpg';
}
function setBackgroundImage(style) {
  const url = getBackgroundByStyle(style);
  document.body.style.setProperty('--bg-url', `url(${url})`);
}

// –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —à–∞–≥ –∫–≤–∏–∑–∞
function showStep(i) {
  currentStep = i;
  const container = document.getElementById('quiz-container');
  container.style.display = 'flex';
  container.innerHTML = '';

  let step = quizSteps[i];
  // –µ—Å–ª–∏ textFunc - –≤—ã–∑–≤–∞—Ç—å —Å –∏–º–µ–Ω–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∏–Ω–∞—á–µ —Ç–µ–∫—Å—Ç –æ–±—ã—á–Ω—ã–π
  let text = step.textFunc ? step.textFunc(quizData.name || '') : step.text;
  const h3 = document.createElement('h3');
  h3.textContent = text;
  container.appendChild(h3);

  // –û—á–∏—Å—Ç–∏–º input / select –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
  if (step.type === 'text') {
    const input = document.createElement('input');
    input.id = 'input';
    input.required = true;
    container.appendChild(input);
    input.focus();
  } else if (step.type === 'select') {
    const select = document.createElement('select');
    select.id = 'input';
    select.required = true;
    step.options.forEach(o => {
      const option = document.createElement('option');
      option.value = o;
      option.textContent = o;
      select.appendChild(option);
    });
    container.appendChild(select);

    // –µ—Å–ª–∏ –Ω—É–∂–Ω–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –¥–æ–ø. –ø–æ–ª–µ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ "–î—Ä—É–≥–æ–µ"
    if(step.withTextInput){
      const textInput = document.createElement('input');
      textInput.id = 'text-input';
      textInput.placeholder = '–ù–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç...';
      textInput.style.display = 'none';
      textInput.style.marginTop = '8px';
      container.appendChild(textInput);

      select.addEventListener('change', () => {
        if (select.value.startsWith('–î—Ä—É–≥–æ–µ')) {
          textInput.style.display = 'block';
          textInput.required = true;
        } else {
          textInput.style.display = 'none';
          textInput.required = false;
          textInput.value = '';
        }
      });
    }

  } else if (step.type === 'multiselect') {
    const div = document.createElement('div');
    div.className = 'multi-select';
    step.options.forEach(o => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.textContent = o;
      btn.onclick = () => {
        btn.classList.toggle('selected');
      };
      div.appendChild(btn);
    });
    container.appendChild(div);
  }

  // –ö–Ω–æ–ø–∫–∞ –î–∞–ª–µ–µ
  const btnNext = document.createElement('button');
  btnNext.textContent = '–î–∞–ª–µ–µ';
  btnNext.onclick = onNextStep;
  container.appendChild(btnNext);
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –î–∞–ª–µ–µ
function onNextStep() {
  const step = quizSteps[currentStep];
  const container = document.getElementById('quiz-container');

  if(step.type === 'multiselect') {
    const selectedBtns = container.querySelectorAll('.multi-select button.selected');
    if (selectedBtns.length === 0) {
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç.');
      return;
    }
    const values = Array.from(selectedBtns).map(btn => btn.textContent);
    quizData[step.key] = values;
  } else {
    const input = container.querySelector('#input');
    if (!input || !input.value.trim()) {
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ.');
      return;
    }

    if(step.withTextInput){
      const textInput = container.querySelector('#text-input');
      if(input.value.startsWith('–î—Ä—É–≥–æ–µ') && (!textInput.value.trim())){
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ.');
        return;
      }
      quizData[step.key] = input.value.startsWith('–î—Ä—É–≥–æ–µ') ? textInput.value.trim() : input.value.trim();
    } else {
      quizData[step.key] = input.value.trim();
    }
  }

  // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–æ–Ω, –µ—Å–ª–∏ –Ω–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º —à–∞–≥–µ ‚Äî –≤ —á–∞—Ç –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
  if (step.key === 'coaching_style') {
    setBackgroundImage(quizData.coaching_style);
  }

  if(currentStep + 1 < quizSteps.length){
    showStep(currentStep + 1);
  } else {
    finishQuiz();
  }
}

async function finishQuiz() {
  document.getElementById('quiz-container').style.display = 'none';
  document.getElementById('loader').style.display = 'flex';
  quizData.last_messages = [];
  quizData.last_greet_ts = new Date().toISOString();

  // –î–æ–±–∞–≤–∏–º –¥–∞—Ç—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –µ—Å–ª–∏ –Ω–µ—Ç
  if(!quizData.signup_date){
    quizData.signup_date = new Date().toISOString();
  }

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
  await saveQuizData(quizData);

  // –ó–∞–ø—É—Å–∫–∞–µ–º —á–∞—Ç
  await startChat(false, quizData);

  document.getElementById('loader').style.display = 'none';
}

// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
async function saveQuizData(data) {
  try {
    const res = await fetch(SHEETS_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: userId, ...data })
    });
    return await res.json();
  } catch(e) {
    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: ' + e.message);
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Å–µ—Ä–≤–µ—Ä–∞
async function fetchUserData() {
  try {
    const res = await fetch(`${SHEETS_API_URL}?user_id=${userId}`);
    const json = await res.json();
    return json?.data || null;
  } catch(e) {
    return null;
  }
}

async function sendMessageToAI(userMessage, isFirst = false) {
  const profileText = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${quizData.name}, –±–µ–≥–∞–µ—Ç ${quizData.running_frequency} —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é, —Å—Ç–∏–ª—å: ${quizData.coaching_style}`;
  const history = (quizData.last_messages || []).concat([{ role: 'user', text: userMessage }]);
  let prompt = `${profileText}\n\n–ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞:\n`;
  history.forEach(m => {
    prompt += (m.role === 'user' ? '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ' : 'AI: ') + m.text + '\n';
  });
  if (isFirst) {
    prompt += `–û—Ç–≤–µ—Ç—å –æ—Ç –º—É–∂—Å–∫–æ–≥–æ –∏–º–µ–Ω–∏. –ü–æ–∑–¥—Ä–∞–≤—å, —á—Ç–æ –æ–Ω –≤–º–µ—Å—Ç–µ —Å Duco AI. –ó–∞–¥–∞–π –ø–æ–ª–µ–∑–Ω—ã–µ, –≤–æ–æ–¥—É—à–µ–≤–ª—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã: –∫–æ–≥–¥–∞ –ø–ª–∞–Ω–∏—Ä—É–µ—à—å –Ω–∞—á–∞—Ç—å –±–µ–≥–∞—Ç—å? –≥–¥–µ —Ö–æ—á–µ—à—å –±–µ–≥–∞—Ç—å (—É–ª–∏—Ü–∞, —Å—Ç–∞–¥–∏–æ–Ω)? –∫–∞–∫–∏–µ —É —Ç–µ–±—è —Ü–µ–ª–∏ ‚Äî –≤–µ—Å, —Ñ–æ—Ä–º–∞, –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞? –ü–∏—à–∏ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ, –∫–æ—Ä–æ—Ç–∫–æ (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è).`;
  } else {
    prompt += '–û—Ç–≤–µ—Ç—å –∫—Ä–∞—Ç–∫–æ –æ—Ç –º—É–∂—Å–∫–æ–≥–æ –∏–º–µ–Ω–∏, –ø–æ–Ω—è—Ç–Ω–æ –∏ —Å –∑–∞–±–æ—Ç–æ–π. –ü—Ä–µ–¥–ª–æ–∂–∏ —á—Ç–æ-—Ç–æ. –†–∞—Å–∫—Ä–æ–π –µ–≥–æ –º—ã—Å–ª—å. –ù–µ –±–æ–ª—å—à–µ 4-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π.';
  }
  try {
    const res = await fetch(GEMINI_API_URL, {
      method: 'POST',
      body: JSON.stringify({ prompt }),
      headers: { 'Content-Type': 'application/json' }
    });
    const json = await res.json();
    return json?.response || '–û—Ç–≤–µ—Ç –æ—Ç Duco AI –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
  } catch {
    return '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞ –æ—Ç AI.';
  }
}

// –ó–∞–ø—É—Å–∫ —á–∞—Ç–∞
async function startChat(skipGreeting = false, localQuizData = null) {
  const messagesDiv = document.getElementById('messages');
  const chatForm = document.getElementById('chat-form');
  const input = document.getElementById('user-input');
  const button = chatForm.querySelector('button');

  let userData = localQuizData;
  if (!userData) userData = await fetchUserData();

  if (!userData || !userData.name || !userData.running_frequency) {
    document.getElementById('loader').style.display = 'none';
    document.getElementById('quiz-container').style.display = 'flex';
    return showStep(0);
  }

  quizData = userData;
  setBackgroundImage(quizData.coaching_style);

  const history = quizData.last_messages || [];
  document.getElementById('chat-container').style.display = 'flex';
  document.getElementById('loader').style.display = 'none';
  messagesDiv.innerHTML = '';
  input.disabled = false;
  button.disabled = true;

  input.addEventListener('input', () => {
    button.disabled = input.value.trim() === '';
  });

  document.body.addEventListener('click', (e) => {
    if (!chatForm.contains(e.target)) {
      input.blur();
    }
  });

  for (const msg of history) {
    const cls = msg.role === 'user' ? 'user' : 'ai';
    messagesDiv.innerHTML += `<div class="msg ${cls}">${msg.text}</div>`;
  }
  messagesDiv.scrollTop = messagesDiv.scrollHeight;

  if (!skipGreeting && history.length === 0) {
    const typing = document.createElement('div');
    typing.className = 'msg ai';
    messagesDiv.appendChild(typing);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;

    const reply = await sendMessageToAI('–ü—Ä–∏–≤–µ—Ç! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—à—ë–ª –∫–≤–∏–∑, –Ω–∞—á–Ω–∏ –±–µ—Å–µ–¥—É.', true);
    typeText(typing, reply);

    quizData.last_messages = [{ role: 'ai', text: reply }];
    await saveQuizData(quizData);
  }

  chatForm.onsubmit = async (e) => {
    e.preventDefault();
    const text = input.value.trim();
    if (!text) return;

    messagesDiv.innerHTML += `<div class="msg user">${text}</div>`;
    input.value = '';
    button.disabled = true;
    messagesDiv.scrollTop = messagesDiv.scrollHeight;

    const typing = document.createElement('div');
    typing.className = 'msg ai';
    messagesDiv.appendChild(typing);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;

    const reply = await sendMessageToAI(text);
    typeText(typing, reply);

    const updated = [...(quizData.last_messages || []), { role: 'user', text }, { role: 'ai', text: reply }].slice(-15);
    quizData.last_messages = updated;
    await saveQuizData(quizData);
  };
}

// –≠—Ñ—Ñ–µ–∫—Ç –ø–µ—á–∞—Ç–∏ —Ç–µ–∫—Å—Ç–∞ –≤ —á–∞—Ç
function typeText(el, text, speed = 20) {
  let i = 0;
  el.textContent = '';
  const interval = setInterval(() => {
    el.textContent += text[i];
    el.parentElement.scrollTop = el.parentElement.scrollHeight;
    i++;
    if (i >= text.length) clearInterval(interval);
  }, speed);
}

document.addEventListener('DOMContentLoaded', async () => {
  if (window.Telegram && Telegram.WebApp?.initDataUnsafe?.user?.id) {
    Telegram.WebApp.ready();
    userId = Telegram.WebApp.initDataUnsafe.user.id.toString();
  }
  await startChat(true);
});
</script>
</body>
</html>
