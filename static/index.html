<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Healthie AI</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="styles.css">
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell;
      background-color: #f5f5f5;
    }

    #loader {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      font-size: 1.2em;
      color: #888;
    }

    #quiz-container, #chat-container {
      display: none;
      max-width: 100%;
      height: 100vh;
      box-sizing: border-box;
      padding: 20px 16px 80px;
      background: white;
    }

    #quiz-container h3 {
      text-align: center;
      font-size: 1.2em;
      margin-bottom: 20px;
    }

    #quiz-container input,
    #quiz-container select {
      width: 100%;
      padding: 12px;
      margin-bottom: 20px;
      border-radius: 16px;
      border: 1px solid #ccc;
      font-size: 1em;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    #quiz-container button {
      width: 100%;
      padding: 12px;
      background-color: #5865F2;
      color: white;
      border: none;
      border-radius: 20px;
      font-size: 1em;
      transition: background 0.3s ease;
    }

    #quiz-container button:hover {
      background-color: #4752c4;
    }

    #messages {
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      max-height: calc(100vh - 120px);
      padding-bottom: 10px;
    }

    .msg {
      max-width: 80%;
      padding: 10px 14px;
      margin: 6px;
      border-radius: 18px;
      font-size: 0.95em;
      line-height: 1.4;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .user {
      background-color: #d0f0ff;
      align-self: flex-end;
      border-bottom-right-radius: 2px;
    }

    .ai {
      background-color: #eee;
      align-self: flex-start;
      border-bottom-left-radius: 2px;
    }

    #chat-form {
      display: flex;
      align-items: center;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      padding: 8px 12px;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
    }

    #user-input {
      flex-grow: 1;
      border: 1px solid #ccc;
      border-radius: 20px;
      padding: 10px 16px;
      font-size: 1em;
      margin-right: 8px;
      outline: none;
      background: #f9f9f9;
    }

    #chat-form button {
      background-color: #5865F2;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    #chat-form button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    #chat-form button svg {
      fill: white;
      width: 20px;
      height: 20px;
    }
  </style>
</head>
<body>
  <div id="loader">Загрузка Healthie AI...</div>
  <div id="quiz-container"></div>
  <div id="chat-container">
    <div id="messages"></div>
    <form id="chat-form">
      <input type="text" id="user-input" placeholder="Сообщение..." disabled />
      <button type="submit" disabled>
        <svg viewBox="0 0 24 24"><path d="M2,21L23,12L2,3V10L17,12L2,14V21Z"/></svg>
      </button>
    </form>
  </div>

  <script>
    const SHEETS_API_URL = 'https://cold-credit-3c5d.arsivals.workers.dev/sheet';
    const GEMINI_API_URL = 'https://cold-credit-3c5d.arsivals.workers.dev/gemini';

    let userId = 'test_user';
    let quizData = {};

    const quizSteps = [
      { key: 'name', text: 'Как тебя зовут?', type: 'text' },
      { key: 'running_frequency', text: 'Сколько раз в неделю хочешь бегать?', type: 'select', options: ['1', '2', '3', '4+'] },
      { key: 'coaching_style', text: 'Выбери стиль общения:', type: 'select', options: ['Железный Наставник', 'Энерджайзер-Зажигалка', 'Спокойный Мудрец', 'АБСОЛЮТНЫЙ ДОМИНАТОР'] },
      { key: 'dominant_style_consent', text: 'Подтверждаешь "ДОМИНАТОРА"?', type: 'select', options: ['нет', 'да'] }
    ];

    async function fetchUserData() {
      const res = await fetch(`${SHEETS_API_URL}?user_id=${userId}`);
      const json = await res.json();
      return json?.data || null;
    }

    async function saveQuizData(data) {
      const res = await fetch(SHEETS_API_URL, {
        method: 'POST',
        body: JSON.stringify({ user_id: userId, ...data }),
        headers: { 'Content-Type': 'application/json' }
      });
      return await res.json();
    }

    async function sendMessageToAI(userMessage) {
      const profileText = `Пользователь: ${quizData.name}, бегает ${quizData.running_frequency} раз в неделю, стиль: ${quizData.coaching_style}`;
      const history = (quizData.last_messages || []).concat([{ role: 'user', text: userMessage }]);
      let prompt = `${profileText}\n\nИстория диалога:\n`;
      history.forEach(m => {
        prompt += (m.role === 'user' ? 'Пользователь: ' : 'AI: ') + m.text + '\n';
      });
      prompt += 'Ответь последовательно и мотивирующе.';

      const res = await fetch(GEMINI_API_URL, {
        method: 'POST',
        body: JSON.stringify({ prompt }),
        headers: { 'Content-Type': 'application/json' }
      });
      const json = await res.json();
      return json?.response || 'Ответ от AI отсутствует';
    }

    function showStep(i) {
      const container = document.getElementById('quiz-container');
      const step = quizSteps[i];
      container.style.display = 'block';
      container.innerHTML = `<h3>${step.text}</h3>`;
      const inputHtml = step.type === 'text'
        ? `<input id="input" required />`
        : `<select id="input">${step.options.map(o => `<option value="${o}">${o}</option>`).join('')}</select>`;
      container.innerHTML += inputHtml + `<button id="next">Далее</button>`;

      document.getElementById('next').onclick = () => {
        const val = document.getElementById('input').value.trim();
        if (!val) return;
        quizData[step.key] = (step.key === 'dominant_style_consent' && quizData.coaching_style !== 'АБСОЛЮТНЫЙ ДОМИНАТОР') ? 'нет' : val;
        if (i + 1 < quizSteps.length) showStep(i + 1);
        else finishQuiz();
      };
    }

    async function finishQuiz() {
      document.getElementById('quiz-container').style.display = 'none';
      document.getElementById('loader').style.display = 'flex';
      quizData.last_messages = [];
      quizData.last_greet_ts = new Date().toISOString();
      await saveQuizData(quizData);
      await startChat(false);
    }

    async function startChat(skipGreeting = false) {
      const messagesDiv = document.getElementById('messages');
      const form = document.getElementById('chat-form');
      const input = document.getElementById('user-input');
      const button = form.querySelector('button');

      const userData = await fetchUserData();
      if (!userData || !userData.name || !userData.running_frequency) {
        document.getElementById('loader').style.display = 'none';
        return showStep(0);
      }

      quizData = userData;
      const history = quizData.last_messages || [];

      document.getElementById('chat-container').style.display = 'block';
      document.getElementById('loader').style.display = 'none';
      messagesDiv.innerHTML = '';
      input.disabled = false;
      button.disabled = true;

      input.addEventListener('input', () => {
        button.disabled = input.value.trim() === '';
      });

      for (const msg of history) {
        const cls = msg.role === 'user' ? 'user' : 'ai';
        messagesDiv.innerHTML += `<div class="msg ${cls}">${msg.text}</div>`;
      }
      messagesDiv.scrollTop = messagesDiv.scrollHeight;

      if (!skipGreeting && history.length === 0) {
        const typing = document.createElement('div');
        typing.className = 'msg ai';
        typing.textContent = 'Healthie AI печатает...';
        messagesDiv.appendChild(typing);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        const reply = await sendMessageToAI('Привет! Пользователь прошёл квиз, начни беседу.');

        typing.remove();
        messagesDiv.innerHTML += `<div class="msg ai">${reply}</div>`;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        const updated = [{ role: 'ai', text: reply }];
        quizData.last_messages = updated;
        await saveQuizData(quizData);
      }

      form.onsubmit = async (e) => {
        e.preventDefault();
        const text = input.value.trim();
        if (!text) return;

        messagesDiv.innerHTML += `<div class="msg user">${text}</div>`;
        input.value = '';
        button.disabled = true;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        const typing = document.createElement('div');
        typing.className = 'msg ai';
        typing.textContent = 'Healthie AI печатает...';
        messagesDiv.appendChild(typing);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        const reply = await sendMessageToAI(text);

        typing.remove();
        messagesDiv.innerHTML += `<div class="msg ai">${reply}</div>`;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        const updated = [...(quizData.last_messages || []), { role: 'user', text }, { role: 'ai', text: reply }].slice(-15);
        quizData.last_messages = updated;
        await saveQuizData(quizData);
      };
    }

    document.addEventListener('DOMContentLoaded', async () => {
      if (window.Telegram && Telegram.WebApp?.initDataUnsafe?.user?.id) {
        Telegram.WebApp.ready();
        userId = Telegram.WebApp.initDataUnsafe.user.id.toString();
      }
      await startChat(true);
    });
  </script>
</body>
</html>
