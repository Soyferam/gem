<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Duco AI</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
      overflow: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-image: var(--bg-url, url('bg/default.jpg'));
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      z-index: -1;
    }

    #loader {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      font-size: 1.2em;
      color: #fff;
      backdrop-filter: blur(6px);
    }

    #quiz-container, #chat-container {
      max-width: 500px;
      margin: auto;
      height: 100vh;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
      padding: 1em;
      background: transparent;
    }

    #quiz-container {
      justify-content: center;
      align-items: center;
      text-align: center;
      transition: all 0.3s ease-in-out;
    }

    #quiz-container h3 {
      font-size: 1.4em;
      color: #fff;
      margin-bottom: 1em;
      max-width: 90%;
    }

    #quiz-container input,
    #quiz-container select {
      width: 100%;
      padding: 14px;
      font-size: 1.1em;
      border-radius: 20px;
      border: none;
      margin-bottom: 1em;
      background: rgba(255, 255, 255, 0.9);
      color: #000;
      transition: all 0.3s ease;
    }

    #quiz-container button {
      padding: 14px 20px;
      font-size: 1.1em;
      border: none;
      border-radius: 25px;
      background-color: #5865F2;
      color: white;
      width: 100%;
      transition: all 0.3s ease;
    }

    #messages {
      flex-grow: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
      padding-bottom: 10px;
    }

    .msg {
      padding: 10px 16px;
      border-radius: 20px;
      max-width: 45%;
      word-wrap: break-word;
      font-size: 1em;
    }

    .user {
      background: rgba(240, 240, 240, 0.9);
      align-self: flex-end;
    }

    .ai {
      background: rgba(208, 240, 255, 0.9);
      align-self: flex-end;
    }

    #chat-form {
      display: flex;
      gap: 8px;
    }

    #chat-form input {
      flex-grow: 1;
      border-radius: 20px;
      padding: 10px;
      border: none;
      font-size: 1em;
      background: rgba(255,255,255,0.9);
      transition: all 0.3s ease;
    }

    #chat-form button {
      border: none;
      background-color: #5865F2;
      color: white;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      font-size: 1.2em;
      transition: all 0.3s ease;
    }

    #chat-form button:disabled {
      background: #ccc;
    }
  </style>
</head>
<body>
<div id="loader">–ó–∞–≥—Ä—É–∑–∫–∞ Duco AI...</div>
<div id="quiz-container" style="display:none;"></div>
<div id="chat-container" style="display:none;">
  <div id="messages"></div>
  <form id="chat-form">
    <input type="text" id="user-input" placeholder="–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off" required disabled />
    <button type="submit" disabled>‚û§</button>
  </form>
</div>

<script>
const SHEETS_API_URL = 'https://cold-credit-3c5d.arsivals.workers.dev/sheet';
const GEMINI_API_URL = 'https://cold-credit-3c5d.arsivals.workers.dev/gemini';

let userId = 'test_user';
let quizData = {};

const quizSteps = [
  { key: 'name', text: '–ü—Ä–∏–≤–µ—Ç! –î–∞–≤–∞–π –∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è üòä –ö–∞–∫ —è –º–æ–≥—É –∫ —Ç–µ–±–µ –æ–±—Ä–∞—â–∞—Ç—å—Å—è?', type: 'text' },
  { key: 'running_frequency', text: '–°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é —Ö–æ—á–µ—à—å –±–µ–≥–∞—Ç—å?', type: 'select', options: ['1', '2', '3', '4+'] },
  { key: 'coaching_style', text: '–í—ã–±–µ—Ä–∏ —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è:', type: 'select', options: ['–ñ–µ–ª–µ–∑–Ω—ã–π –ù–∞—Å—Ç–∞–≤–Ω–∏–∫', '–≠–Ω–µ—Ä–¥–∂–∞–π–∑–µ—Ä-–ó–∞–∂–∏–≥–∞–ª–∫–∞', '–°–ø–æ–∫–æ–π–Ω—ã–π –ú—É–¥—Ä–µ—Ü', '–ê–ë–°–û–õ–Æ–¢–ù–´–ô –î–û–ú–ò–ù–ê–¢–û–†'] },
  { key: 'dominant_style_consent', text: '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—à—å "–î–û–ú–ò–ù–ê–¢–û–†–ê"?', type: 'select', options: ['–Ω–µ—Ç', '–¥–∞'] }
];

function getBackgroundByStyle(style) {
  const map = {
    '–ñ–µ–ª–µ–∑–Ω—ã–π –ù–∞—Å—Ç–∞–≤–Ω–∏–∫': 'bg/iron.jpg',
    '–≠–Ω–µ—Ä–¥–∂–∞–π–∑–µ—Ä-–ó–∞–∂–∏–≥–∞–ª–∫–∞': 'bg/energizer.jpg',
    '–°–ø–æ–∫–æ–π–Ω—ã–π –ú—É–¥—Ä–µ—Ü': 'bg/sage.jpg',
    '–ê–ë–°–û–õ–Æ–¢–ù–´–ô –î–û–ú–ò–ù–ê–¢–û–†': 'bg/dominator.jpg'
  };
  return map[style] || 'bg/default.jpg';
}

function setBackgroundImage(style) {
  const url = getBackgroundByStyle(style);
  document.body.style.setProperty('--bg-url', `url(${url})`);
}

function typeText(el, text, speed = 20) {
  let i = 0;
  const interval = setInterval(() => {
    el.textContent += text[i];
    i++;
    if (i >= text.length) clearInterval(interval);
  }, speed);
}

async function fetchUserData() {
  const res = await fetch(`${SHEETS_API_URL}?user_id=${userId}`);
  const json = await res.json();
  return json?.data || null;
}

async function saveQuizData(data) {
  const res = await fetch(SHEETS_API_URL, {
    method: 'POST',
    body: JSON.stringify({ user_id: userId, ...data }),
    headers: { 'Content-Type': 'application/json' }
  });
  return await res.json();
}

async function sendMessageToAI(userMessage, isFirst = false) {
  const profileText = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${quizData.name}, –±–µ–≥–∞–µ—Ç ${quizData.running_frequency} —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é, —Å—Ç–∏–ª—å: ${quizData.coaching_style}`;
  const history = (quizData.last_messages || []).concat([{ role: 'user', text: userMessage }]);
  let prompt = `${profileText}\n\n–ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞:\n`;
  history.forEach(m => {
    prompt += (m.role === 'user' ? '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ' : 'AI: ') + m.text + '\n';
  });

  if (isFirst) {
    prompt += `–û—Ç–≤–µ—Ç—å –æ—Ç –º—É–∂—Å–∫–æ–≥–æ –∏–º–µ–Ω–∏. –ü–æ–∑–¥—Ä–∞–≤—å —á—Ç–æ –æ–Ω –≤–º–µ—Å—Ç–µ —Å Duco AI. –ó–∞–¥–∞–π –ø–æ–ª–µ–∑–Ω—ã–µ –∏ –≤–æ–æ–¥—É—à–µ–≤–ª—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã: –∫–æ–≥–¥–∞ –ø–ª–∞–Ω–∏—Ä—É–µ—à—å –Ω–∞—á–∞—Ç—å –±–µ–≥–∞—Ç—å? –≥–¥–µ —Ö–æ—á–µ—à—å –±–µ–≥–∞—Ç—å (—É–ª–∏—Ü–∞, —Å—Ç–∞–¥–∏–æ–Ω)? –∫–∞–∫–∏–µ —É —Ç–µ–±—è —Ü–µ–ª–∏ ‚Äî –≤–µ—Å, —Ñ–æ—Ä–º–∞, –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞? –ü–∏—à–∏ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ, –∫–æ—Ä–æ—Ç–∫–æ (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è).`;
  } else {
    prompt += '–û—Ç–≤–µ—Ç—å –∫—Ä–∞—Ç–∫–æ, –ø–æ–Ω—è—Ç–Ω–æ –∏ —Å –∑–∞–±–æ—Ç–æ–π. –ù–µ –±–æ–ª—å—à–µ 4-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π.';
  }

  const res = await fetch(GEMINI_API_URL, {
    method: 'POST',
    body: JSON.stringify({ prompt }),
    headers: { 'Content-Type': 'application/json' }
  });
  const json = await res.json();
  return json?.response || '–û—Ç–≤–µ—Ç –æ—Ç Duco AI –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
}

function showStep(i) {
  setBackgroundImage('default');
  const container = document.getElementById('quiz-container');
  const step = quizSteps[i];
  container.style.display = 'flex';
  container.innerHTML = `<h3>${step.text}</h3>`;
  const inputHtml = step.type === 'text'
    ? `<input id="input" required />`
    : `<select id="input">${step.options.map(o => `<option value="${o}">${o}</option>`).join('')}</select>`;
  container.innerHTML += inputHtml + `<button id="next">–î–∞–ª–µ–µ</button>`;

  document.getElementById('next').onclick = () => {
    const val = document.getElementById('input').value.trim();
    if (!val) return;
    quizData[step.key] = (step.key === 'dominant_style_consent' && quizData.coaching_style !== '–ê–ë–°–û–õ–Æ–¢–ù–´–ô –î–û–ú–ò–ù–ê–¢–û–†') ? '–Ω–µ—Ç' : val;
    if (i + 1 < quizSteps.length) showStep(i + 1);
    else finishQuiz();
  };
}

async function finishQuiz() {
  document.getElementById('quiz-container').style.display = 'none';
  document.getElementById('loader').style.display = 'flex';
  quizData.last_messages = [];
  quizData.last_greet_ts = new Date().toISOString();
  await saveQuizData(quizData);
  await startChat(false, quizData);
  document.getElementById('loader').style.display = 'none';
}

async function startChat(skipGreeting = false, localQuizData = null) {
  const messagesDiv = document.getElementById('messages');
  const chatForm = document.getElementById('chat-form');
  const input = document.getElementById('user-input');
  const button = chatForm.querySelector('button');

  let userData = localQuizData;
  if (!userData) userData = await fetchUserData();

  if (!userData || !userData.name || !userData.running_frequency) {
    document.getElementById('loader').style.display = 'none';
    document.getElementById('quiz-container').style.display = 'flex';
    return showStep(0);
  }

  quizData = userData;
  setBackgroundImage(quizData.coaching_style);

  const history = quizData.last_messages || [];
  document.getElementById('chat-container').style.display = 'flex';
  document.getElementById('loader').style.display = 'none';
  messagesDiv.innerHTML = '';
  input.disabled = false;
  button.disabled = true;

  input.addEventListener('input', () => {
    button.disabled = input.value.trim() === '';
  });

  for (const msg of history) {
    const cls = msg.role === 'user' ? 'user' : 'ai';
    messagesDiv.innerHTML += `<div class="msg ${cls}">${msg.text}</div>`;
  }
  messagesDiv.scrollTop = messagesDiv.scrollHeight;

  if (!skipGreeting && history.length === 0) {
    const typing = document.createElement('div');
    typing.className = 'msg ai';
    messagesDiv.appendChild(typing);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;

    const reply = await sendMessageToAI('–ü—Ä–∏–≤–µ—Ç! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—à—ë–ª –∫–≤–∏–∑, –Ω–∞—á–Ω–∏ –±–µ—Å–µ–¥—É.', true);
    typeText(typing, reply);

    quizData.last_messages = [{ role: 'ai', text: reply }];
    await saveQuizData(quizData);
  }

  chatForm.onsubmit = async (e) => {
    e.preventDefault();
    const text = input.value.trim();
    if (!text) return;

    messagesDiv.innerHTML += `<div class="msg user">${text}</div>`;
    input.value = '';
    button.disabled = true;
    messagesDiv.scrollTop = messagesDiv.scrollHeight;

    const typing = document.createElement('div');
    typing.className = 'msg ai';
    messagesDiv.appendChild(typing);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;

    const reply = await sendMessageToAI(text);
    typeText(typing, reply);

    const updated = [...(quizData.last_messages || []), { role: 'user', text }, { role: 'ai', text: reply }].slice(-15);
    quizData.last_messages = updated;
    await saveQuizData(quizData);
  };
}

document.addEventListener('DOMContentLoaded', async () => {
  if (window.Telegram && Telegram.WebApp?.initDataUnsafe?.user?.id) {
    Telegram.WebApp.ready();
    userId = Telegram.WebApp.initDataUnsafe.user.id.toString();
  }
  await startChat(true);
});
</script>
</body>
</html>