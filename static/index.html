<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Healthie AI</title>
  <style>
    body { font-family: sans-serif; padding: 1em; background: #f4f4f4; }
    #quiz-container, #chat-container {
      max-width: 500px; margin: auto; background: white; padding: 1em; border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    #messages {
      max-height: 400px; overflow-y: auto; margin-bottom: 1em;
      display: flex; flex-direction: column;
    }
    .msg { padding: 0.5em; margin: 0.5em 0; border-radius: 10px; }
    .user { background: #d0f0ff; align-self: flex-end; }
    .ai { background: #f0f0f0; align-self: flex-start; }
    #loader, #typing-indicator { text-align: center; padding: 1em; font-style: italic; }
    #typing-indicator {
      font-size: 0.9em;
      color: #888;
    }
  </style>
</head>
<body>

<div id="quiz-container" style="display:none;"></div>
<div id="chat-container" style="display:none;">
  <h2>Healthie AI</h2>
  <div id="messages"></div>
  <form id="chat-form">
    <input type="text" id="user-input" placeholder="Ваше сообщение..." autocomplete="off" required />
    <button type="submit">Отправить</button>
  </form>
</div>
<div id="loader" style="display:none;">Загрузка...</div>

<script>
  const SHEETS_API_URL = 'https://cold-credit-3c5d.arsivals.workers.dev/sheet';
  const GEMINI_API_URL = 'https://cold-credit-3c5d.arsivals.workers.dev/gemini';

  const getUserId = () => {
    try {
      if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe?.user?.id) {
        return Telegram.WebApp.initDataUnsafe.user.id.toString();
      }
    } catch {}
    return 'test_user';
  };

  const quizSteps = [
    { key: 'name', text: 'Как тебя зовут?', type: 'text' },
    { key: 'running_frequency', text: 'Сколько раз в неделю хочешь бегать?', type: 'select', options: ['1', '2', '3', '4+'] },
    { key: 'coaching_style', text: 'Выбери стиль общения:', type: 'select', options: ['Железный Наставник', 'Энерджайзер-Зажигалка', 'Спокойный Мудрец', 'АБСОЛЮТНЫЙ ДОМИНАТОР'] },
    { key: 'dominant_style_consent', text: 'Подтверждаешь "ДОМИНАТОРА"?', type: 'select', options: ['нет', 'да'] }
  ];

  let quizData = {};

  async function fetchUserData() {
    const user_id = getUserId();
    try {
      const res = await fetch(`${SHEETS_API_URL}?user_id=${user_id}`);
      const json = await res.json();
      return json?.data || null;
    } catch (e) {
      return null;
    }
  }

  async function saveQuizData(data) {
    const user_id = getUserId();
    const body = { user_id, ...data };
    const res = await fetch(SHEETS_API_URL, {
      method: 'POST',
      body: JSON.stringify(body),
      headers: { 'Content-Type': 'application/json' }
    });
    return await res.json();
  }

  async function sendMessageToAI(userMessage) {
    const profileText = `Пользователь: ${quizData.name}, хочет бегать ${quizData.running_frequency} раз в неделю, стиль: ${quizData.coaching_style}.`;
    const conversation = (quizData.last_messages || []).concat([{ role: 'user', text: userMessage }]);
    let prompt = `Ты — AI-тренер по бегу. ${profileText}\n\nИстория диалога:\n`;
    conversation.forEach(msg => {
      prompt += (msg.role === 'user' ? 'Пользователь: ' : 'AI: ') + msg.text + '\n';
    });
    prompt += 'Ответь последовательно и мотивирующе.';

    const res = await fetch(GEMINI_API_URL, {
      method: 'POST',
      body: JSON.stringify({ prompt }),
      headers: { 'Content-Type': 'application/json' }
    });
    const json = await res.json();
    return json?.response || 'Ответ от AI отсутствует';
  }

  function showStep(i) {
    const quizContainer = document.getElementById('quiz-container');
    const st = quizSteps[i];
    quizContainer.innerHTML = `<h3>${st.text}</h3>`;
    const inputHtml = st.type === 'text'
      ? `<input id="input" required />`
      : `<select id="input">${st.options.map(o => `<option value="${o}">${o}</option>`).join('')}</select>`;
    quizContainer.innerHTML += inputHtml + `<button id="next">Далее</button>`;
    document.getElementById('next').onclick = () => {
      const val = document.getElementById('input').value.trim();
      if (!val) return;
      quizData[st.key] = (st.type === 'select' && st.key === 'dominant_style_consent' && quizData.coaching_style !== 'АБСОЛЮТНЫЙ ДОМИНАТОР') ? 'нет' : val;
      if (i + 1 < quizSteps.length) showStep(i + 1);
      else finishQuiz();
    };
  }

  async function finishQuiz() {
    document.getElementById('quiz-container').style.display = 'none';
    document.getElementById('loader').style.display = 'block';
    await saveQuizData(quizData);
    await startChat(true);
    document.getElementById('loader').style.display = 'none';
  }

  async function loadChatHistory() {
    const userData = await fetchUserData();
    if (!userData) return [];
    if (userData.last_messages && Array.isArray(userData.last_messages)) {
      quizData = userData;
      return userData.last_messages;
    }
    return [];
  }

  async function updateLastMessages(messages) {
    const dataToSave = {
      ...quizData,
      last_messages: messages
    };
    await saveQuizData(dataToSave);
    quizData.last_messages = messages;
  }

  async function generateGreetingFromAI() {
    const history = quizData.last_messages || [];
    const profileText = `Пользователь: ${quizData.name}, хочет бегать ${quizData.running_frequency} раз в неделю, стиль: ${quizData.coaching_style}.`;
    let prompt = `Ты — AI-тренер по бегу. ${profileText}\n\nИстория диалога:\n`;
    history.forEach(msg => {
      prompt += (msg.role === 'user' ? 'Пользователь: ' : 'AI: ') + msg.text + '\n';
    });
    prompt += `\nПродолжи разговор, прояви заботу и поддержку. Спроси, как у пользователя дела, есть ли прогресс или вопросы. Ответь на русском.`;

    const res = await fetch(GEMINI_API_URL, {
      method: 'POST',
      body: JSON.stringify({ prompt }),
      headers: { 'Content-Type': 'application/json' }
    });
    const json = await res.json();
    return json?.response || 'Привет! Как твои тренировки?';
  }

  async function startChat(withGreeting = false) {
    const chatContainer = document.getElementById('chat-container');
    const messagesDiv = document.getElementById('messages');
    const form = document.getElementById('chat-form');
    const input = document.getElementById('user-input');

    chatContainer.style.display = 'block';
    messagesDiv.innerHTML = '';

    const history = await loadChatHistory();
    quizData.last_messages = history;
    const lastMsg = history[history.length - 1];

    for (const msg of history) {
      const cls = msg.role === 'user' ? 'user' : 'ai';
      messagesDiv.innerHTML += `<div class="msg ${cls}">${msg.text}</div>`;
    }
    messagesDiv.scrollTop = messagesDiv.scrollHeight;

    if (withGreeting) {
  const lastGreeted = quizData.last_greet_ts ? new Date(quizData.last_greet_ts).getTime() : 0;
  const now = Date.now();

  const isOnlyAIInHistory = history.every(m => m.role === 'ai');
  const shouldGreet = (!quizData.last_greet_ts || now - lastGreeted > 6 * 60 * 60 * 1000) && !isOnlyAIInHistory;

  if (history.length === 0) {
    // Первый вход после квиза
    const profileText = `Пользователь: ${quizData.name}, хочет бегать ${quizData.running_frequency} раз в неделю, стиль: ${quizData.coaching_style}.`;
    const prompt = `Ты — AI-тренер по бегу. ${profileText}\n\nПользователь только что завершил квиз. Начни первый диалог на тему бега.`;
    const reply = await sendMessageToAI(prompt);
    messagesDiv.innerHTML += `<div class="msg ai">${reply}</div>`;
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    await updateLastMessages([{ role: 'ai', text: reply }]);
    quizData.last_greet_ts = new Date().toISOString();
    await saveQuizData(quizData);
  } else if (shouldGreet) {
    // Повторное приветствие спустя >6 часов
    const greetMsg = await generateGreetingFromAI();
    messagesDiv.innerHTML += `<div class="msg ai">${greetMsg}</div>`;
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    const updatedMessages = [...quizData.last_messages, { role: 'ai', text: greetMsg }].slice(-15);
    quizData.last_messages = updatedMessages;
    quizData.last_greet_ts = new Date().toISOString();
    await saveQuizData({
      ...quizData,
      last_messages: updatedMessages,
      last_greet_ts: quizData.last_greet_ts
    });
  }
}

    form.onsubmit = async (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text) return;

      messagesDiv.innerHTML += `<div class="msg user">${text}</div>`;
      input.value = '';
      messagesDiv.scrollTop = messagesDiv.scrollHeight;

      const typingDiv = document.createElement('div');
      typingDiv.id = 'typing-indicator';
      typingDiv.textContent = 'Healthie AI печатает...';
      messagesDiv.appendChild(typingDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;

      const reply = await sendMessageToAI(text);

      typingDiv.remove();
      messagesDiv.innerHTML += `<div class="msg ai">${reply}</div>`;
      messagesDiv.scrollTop = messagesDiv.scrollHeight;

      const updatedMessages = [
        ...(quizData.last_messages || []),
        { role: 'user', text },
        { role: 'ai', text: reply }
      ].slice(-15);

      await updateLastMessages(updatedMessages);
    };
  }

  document.addEventListener('DOMContentLoaded', async () => {
    const existingData = await fetchUserData();
    if (existingData && Object.keys(existingData).length >= quizSteps.length) {
      quizData = existingData;
      await startChat(true);
    } else {
      document.getElementById('quiz-container').style.display = 'block';
      showStep(0);
    }
  });
</script>
</body>
</html>