<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Healthie AI</title>
  <style>
    body { font-family: sans-serif; padding: 1em; background: #f4f4f4; }
    #quiz-container, #chat-container { max-width: 500px; margin: auto; background: white; padding: 1em; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    #messages { max-height: 400px; overflow-y: auto; margin-bottom: 1em; }
    .msg { padding: 0.5em; margin: 0.5em 0; border-radius: 10px; }
    .user { background: #d0f0ff; align-self: flex-end; }
    .ai { background: #f0f0f0; }
    #loader { text-align: center; padding: 1em; font-style: italic; }
  </style>
</head>
<body>
  <div id="quiz-container" style="display: none;"></div>

  <div id="chat-container" style="display: none;">
    <h2>Healthie AI</h2>
    <div id="messages" style="display: flex; flex-direction: column;"></div>
    <form id="chat-form">
      <input type="text" id="user-input" placeholder="–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off" required />
      <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>
  </div>

  <div id="loader" style="display: none;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

  <script>
    const SHEETS_API_URL = 'https://cold-credit-3c5d.arsivals.workers.dev/sheet';
    const GEMINI_API_URL = 'https://cold-credit-3c5d.arsivals.workers.dev/gemini';

    const getUserId = () => {
      try {
        if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe?.user?.id) {
          return Telegram.WebApp.initDataUnsafe.user.id.toString();
        }
      } catch (e) {}
      return 'test_user';
    };

    const quizSteps = [
      { key: 'name', text: '–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?', type: 'text' },
      { key: 'running_frequency', text: '–°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é —Ö–æ—á–µ—à—å –±–µ–≥–∞—Ç—å?', type: 'select', options: ['1', '2', '3', '4+'] },
      { key: 'coaching_style', text: '–í—ã–±–µ—Ä–∏ —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è:', type: 'select', options: ['–ñ–µ–ª–µ–∑–Ω—ã–π –ù–∞—Å—Ç–∞–≤–Ω–∏–∫', '–≠–Ω–µ—Ä–¥–∂–∞–π–∑–µ—Ä-–ó–∞–∂–∏–≥–∞–ª–∫–∞', '–°–ø–æ–∫–æ–π–Ω—ã–π –ú—É–¥—Ä–µ—Ü', '–ê–ë–°–û–õ–Æ–¢–ù–´–ô –î–û–ú–ò–ù–ê–¢–û–†'] },
      { key: 'dominant_style_consent', text: '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—à—å "–î–û–ú–ò–ù–ê–¢–û–†–ê"?', type: 'select', options: ['–Ω–µ—Ç', '–¥–∞'] }
    ];

    let quizData = {};

    async function fetchUserData() {
      const user_id = getUserId();
      try {
        const res = await fetch(`${SHEETS_API_URL}?user_id=${user_id}`);
        const json = await res.json();
        return json?.data || null;
      } catch (e) {
        return null;
      }
    }

    async function saveQuizData(data) {
      const user_id = getUserId();
      const body = { user_id, ...data };
      const res = await fetch(SHEETS_API_URL, {
        method: 'POST',
        body: JSON.stringify(body),
        headers: { 'Content-Type': 'application/json' }
      });
      return await res.json();
    }

    async function sendMessageToAI(prompt) {
      const res = await fetch(GEMINI_API_URL, {
        method: 'POST',
        body: JSON.stringify({ prompt }),
        headers: { 'Content-Type': 'application/json' }
      });
      const json = await res.json();
      return json?.response || '–û—Ç–≤–µ—Ç –Ω–µ –ø–æ–ª—É—á–µ–Ω';
    }

    function showStep(i) {
      const quizContainer = document.getElementById('quiz-container');
      const st = quizSteps[i];
      quizContainer.innerHTML = `<h3>${st.text}</h3>`;
      const inputHtml = st.type === 'text'
        ? `<input id="input" required />`
        : `<select id="input">${st.options.map(o => `<option value="${o}">${o}</option>`).join('')}</select>`;
      quizContainer.innerHTML += inputHtml + `<button id="next">–î–∞–ª–µ–µ</button>`;
      document.getElementById('next').onclick = () => {
        const val = document.getElementById('input').value.trim();
        if (!val) return;
        quizData[st.key] = st.type === 'select' && st.key === 'dominant_style_consent' && quizData.coaching_style !== '–ê–ë–°–û–õ–Æ–¢–ù–´–ô –î–û–ú–ò–ù–ê–¢–û–†' ? '–Ω–µ—Ç' : val;
        if (i + 1 < quizSteps.length) showStep(i + 1);
        else finishQuiz();
      };
    }

    async function finishQuiz() {
      document.getElementById('quiz-container').style.display = 'none';
      document.getElementById('loader').style.display = 'block';
      await saveQuizData(quizData);
      await startChat(true);
      document.getElementById('loader').style.display = 'none';
    }

    async function startChat(withGreeting = false) {
      const chatContainer = document.getElementById('chat-container');
      const messagesDiv = document.getElementById('messages');
      const form = document.getElementById('chat-form');
      const input = document.getElementById('user-input');

      chatContainer.style.display = 'block';
      messagesDiv.innerHTML = '';

      if (withGreeting) {
        const prompt = `–¢—ã ‚Äî ${quizData.coaching_style}. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–æ–ª—å–∫–æ —á—Ç–æ –∑–∞–≤–µ—Ä—à–∏–ª –∫–≤–∏–∑.
–ï–≥–æ –∏–º—è: ${quizData.name}. –û–Ω —Ö–æ—á–µ—Ç –±–µ–≥–∞—Ç—å ${quizData.running_frequency} —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é.
–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–π –µ–≥–æ, –ø–æ–¥–¥–µ—Ä–∂–∏ –∏ –∑–∞–¥–∞–π –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å –ø–æ –±–µ–≥—É. –¢–æ–ª—å–∫–æ –ø–æ-—Ä—É—Å—Å–∫–∏, –±–µ–∑ –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö —Å–ª–æ–≤ –∫—Ä–æ–º–µ –Ω–∞–∑–≤–∞–Ω–∏–π.`;
        const reply = await sendMessageToAI(prompt);
        messagesDiv.innerHTML += `<div class="msg ai">ü§ñ ${reply}</div>`;
      }

      form.onsubmit = async (e) => {
        e.preventDefault();
        const text = input.value.trim();
        if (!text) return;
        messagesDiv.innerHTML += `<div class="msg user">üë§ ${text}</div>`;
        input.value = '';
        const reply = await sendMessageToAI(text);
        messagesDiv.innerHTML += `<div class="msg ai">ü§ñ ${reply}</div>`;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      };
    }

    document.addEventListener('DOMContentLoaded', async () => {
      window.quizContainer = document.getElementById('quiz-container');
      window.chatContainer = document.getElementById('chat-container');
      const existingData = await fetchUserData();
      if (existingData && Object.keys(existingData).length >= quizSteps.length) {
        quizData = existingData;
        await startChat(true);
      } else {
        document.getElementById('quiz-container').style.display = 'block';
        showStep(0);
      }
    });
  </script>
</body>
</html>