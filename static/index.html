<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Healthie AI</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .msg { margin: 10px 0; }
    .loading { color: #999; font-style: italic; }
  </style>
</head>
<body>
  <div id="quiz-container" style="display: none;"></div>

  <div id="chat-container" style="display: none;">
    <h1>Healthie AI</h1>
    <div id="messages" style="max-height: 400px; overflow-y: auto;"></div>
    <form id="chat-form">
      <input type="text" id="user-input" placeholder="–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off" />
      <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>
  </div>

  <script>
    const SHEETS_API_URL = 'https://cold-credit-3c5d.arsivals.workers.dev/sheet';
    const GEMINI_API_URL = 'https://cold-credit-3c5d.arsivals.workers.dev/gemini';

    const getUserId = () => {
      const id = Telegram?.WebApp?.initDataUnsafe?.user?.id;
      if (!id) {
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å Telegram ID. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –∑–∞–ø—É—Å—Ç–∏–ª–∏ Mini App —á–µ—Ä–µ–∑ Telegram.');
        throw new Error('Telegram ID not found');
      }
      return id.toString();
    };

    async function fetchUserData() {
      const user_id = getUserId();
      const res = await fetch(`${SHEETS_API_URL}?user_id=${user_id}`);
      return await res.json();
    }

    async function saveQuizData(data) {
      const user_id = getUserId();
      const body = { user_id, ...data };
      const res = await fetch(SHEETS_API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      return await res.json();
    }

    async function sendMessageToAI(prompt) {
      const res = await fetch(GEMINI_API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt })
      });
      const json = await res.json();
      return json?.response || '–û—à–∏–±–∫–∞ –æ—Ç AI';
    }

    const steps = [
      { key: 'name', text: '–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?', type: 'text' },
      { key: 'running_frequency', text: '–°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é —Ö–æ—á–µ—à—å –±–µ–≥–∞—Ç—å?', type: 'select', options: ['1', '2', '3', '4+'] },
      { key: 'coaching_style', text: '–í—ã–±–µ—Ä–∏ —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è:', type: 'select', options: ['–ñ–µ–ª–µ–∑–Ω—ã–π –ù–∞—Å—Ç–∞–≤–Ω–∏–∫', '–≠–Ω–µ—Ä–¥–∂–∞–π–∑–µ—Ä-–ó–∞–∂–∏–≥–∞–ª–∫–∞', '–°–ø–æ–∫–æ–π–Ω—ã–π –ú—É–¥—Ä–µ—Ü', '–ê–ë–°–û–õ–Æ–¢–ù–´–ô –î–û–ú–ò–ù–ê–¢–û–†'] },
      { key: 'dominant_style_consent', text: '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—à—å "–î–û–ú–ò–ù–ê–¢–û–†–ê"?', type: 'select', options: ['–Ω–µ—Ç', '–¥–∞'] }
    ];

    let quizData = {};
    let quizContainer, chatContainer, messagesDiv;
    let firstMessageSent = false;

    function showStep(i) {
      const st = steps[i];
      quizContainer.innerHTML = `<h3>${st.text}</h3>`;
      const inputHtml = st.type === 'text'
        ? `<input id="input" required>`
        : `<select id="input">${st.options.map(o => `<option value="${o}">${o}</option>`).join('')}</select>`;
      quizContainer.innerHTML += inputHtml + `<button id="next">–î–∞–ª–µ–µ</button>`;
      document.getElementById('next').onclick = () => {
        const val = document.getElementById('input').value.trim();
        if (!val) return;
        quizData[st.key] = st.type === 'select' && st.key === 'dominant_style_consent' && quizData.coaching_style !== '–ê–ë–°–û–õ–Æ–¢–ù–´–ô –î–û–ú–ò–ù–ê–¢–û–†' ? '–Ω–µ—Ç' : val;
        if (i + 1 < steps.length) showStep(i + 1);
        else finishQuiz();
      };
    }

    async function finishQuiz() {
      await saveQuizData(quizData);
      quizContainer.style.display = 'none';
      startChat();
      await sendWelcomeMessage(quizData);
    }

    function startChat() {
      chatContainer.style.display = 'block';

      const form = document.getElementById('chat-form');
      const input = document.getElementById('user-input');

      form.onsubmit = async (e) => {
        e.preventDefault();
        const text = input.value.trim();
        if (!text) return;

        messagesDiv.innerHTML += `<div class="msg user">üë§ ${text}</div>`;
        input.value = '';

        const loading = document.createElement('div');
        loading.className = 'msg loading';
        loading.textContent = 'ü§ñ –ü–µ—á–∞—Ç–∞–µ—Ç...';
        messagesDiv.appendChild(loading);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        const reply = await sendMessageToAI(text);
        loading.remove();
        messagesDiv.innerHTML += `<div class="msg ai">ü§ñ ${reply}</div>`;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      };
    }

    async function sendWelcomeMessage(user) {
      if (firstMessageSent) return; // –∑–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
      firstMessageSent = true;

      const loading = document.createElement('div');
      loading.className = 'msg loading';
      loading.textContent = 'ü§ñ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ...';
      messagesDiv.appendChild(loading);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;

      const prompt = `–¢—ã ‚Äî ${user.coaching_style}. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–æ–ª—å–∫–æ —á—Ç–æ –∑–∞–≤–µ—Ä—à–∏–ª –∫–≤–∏–∑.
–ò–º—è: ${user.name}. –û–Ω —Ö–æ—á–µ—Ç –±–µ–≥–∞—Ç—å ${user.running_frequency} —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é.
–ü–æ–∑–¥–æ—Ä–æ–≤–∞–π—Å—è, –ø–æ–¥–¥–µ—Ä–∂–∏, –∑–∞–¥–∞–π —Ç–æ–Ω –∏ —Å—Ç–∏–ª—å –Ω–∞ —Å—Ç–∞—Ä—Ç–µ –≤ –¥—É—Ö–µ "${user.coaching_style}".
–ü–∏—à–∏ –ø–æ-—Ä—É—Å—Å–∫–∏, –∏–∑–±–µ–≥–∞–π –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö —Å–ª–æ–≤ –∏ –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤ –≤—Ä–æ–¥–µ **–∑–≤—ë–∑–¥–æ—á–µ–∫**.`;

      const reply = await sendMessageToAI(prompt);
      loading.remove();
      messagesDiv.innerHTML += `<div class="msg ai">ü§ñ ${reply}</div>`;
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    document.addEventListener('DOMContentLoaded', async () => {
      quizContainer = document.getElementById('quiz-container');
      chatContainer = document.getElementById('chat-container');
      messagesDiv = document.getElementById('messages');

      try {
        const userData = await fetchUserData();
        if (userData?.success && userData.data?.exists) {
          startChat();
          await sendWelcomeMessage(userData.data);
        } else {
          quizContainer.style.display = 'block';
          showStep(0);
        }
      } catch (e) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        console.error(e);
      }
    });
  </script>
</body>
</html>